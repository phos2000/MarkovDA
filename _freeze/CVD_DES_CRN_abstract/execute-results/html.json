{
  "hash": "8e38e2c003b9ebd8641d1f08bd8c1c87",
  "result": {
    "markdown": "---\ntitle: \"Common Random Numbers in Discrete Event Simulation for Disease Modeling: A Statin Treatment Case Study\"\nauthor: \"Astrid Yu, Shawn Garbett, Jinyi Zhu\"\ndate: \"2023-07-12\"\noutput:\n  html:\n    toc: true\n    code-fold: show\n---\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# source(\"random_draws_for_CVD_PSAs.R\")\n\n# output is the dataset\nRIPS_CVD_data = function(inputs){\n  results <- NULL\n  attributes <- NULL\n  #outputs <- list()\n  \n  for (strategy in 0:1){\n    inputs$strategy = strategy\n    \n    run <- exec.simulation(inputs)\n    run$strategy <- strategy\n    \n    at <- arrange(get_mon_attributes(env),name,key,time) #obtain attributes data\n    at$strategy <- strategy\n    \n    if(is.null(results)) { results <- run } else  {results <- rbind(results, run)}\n    if(is.null(attributes)) { attributes <- at } else  {attributes <- rbind(attributes, at)}\n    rm(run)\n    rm(at)\n  }\n  \n  repeatSets = attributes %>% filter((key == \"aGetCVD\" | key == \"aStatinsMildAdverse\" | key == \"aStatinsMajorAdverse\") & is.infinite(value))\n  \n  casted = setdiff(attributes, repeatSets) %>% select(-replication, -time) %>% spread(key, value)\n  \n  traces = results %>% select(-start_time, -activity_time, -replication) %>% spread(resource, end_time) %>% \n    left_join(casted %>% rename(statins_use = aUseStatins, initial_age = AgeInitial), by = c(\"name\", \"strategy\"))\n  \n  if (is.null(traces$statins_major_adverse_event)) {traces$statins_major_adverse_event = NA}\n  \n  # patientWcea = traces %>% \n  #   rowwise() %>%\n  #   mutate(\n  #     cost_disc = basic_CVD_costs_discounted(inputs, death_after_ASCVD, death_of_ASCVD, death_without_CVD, get_CVD, time_in_model, initial_age) + adjustment_statins_costs_discounted(inputs, statins_use, statins_mild_adverse_event, statins_major_adverse_event, get_CVD, time_in_model),\n  #     util_disc = adjusted_statins_utilities_discounted(inputs, statins_use, statins_mild_adverse_event, statins_major_adverse_event, get_CVD, time_in_model))\n  \n  cost_util = calc_cost_util(death_of_ASCVD_vec = traces$death_of_ASCVD,\n                             get_CVD_vec = traces$get_CVD, \n                             time_in_model_vec = traces$time_in_model, \n                             initial_age_vec = traces$initial_age,\n                             statins_use_vec = traces$statins_use, \n                             statins_mild_adverse_event_vec = traces$statins_mild_adverse_event, \n                             statins_major_adverse_event_vec = traces$statins_major_adverse_event, \n                             n_pop = nrow(traces),\n                             ar = inputs$annual_discount_rate,\n                             bgcost_coef_vec = coef(inputs$model_bgcost), \n                             cvdpct_coef_vec = coef(inputs$model_cvdpct),\n                             cAnnualFU_afterASCVD = inputs$cAnnualFU_afterASCVD,\n                             cNonFatalASCVD = inputs$cNonFatalASCVD,\n                             cFatalASCVD = inputs$cFatalASCVD,\n                             cAnnualStatin = inputs$cAnnualStatin,\n                             cMildStatinAdverse = inputs$cMildStatinAdverse,\n                             cMajorStatinAdverse = inputs$cMajorStatinAdverse,\n                             rInflation2017 = inputs$rInflation2017,\n                             uHealthy = inputs$uHealthy,\n                             uAfterASCVD = inputs$uAfterASCVD,\n                             uHealthyStatin = inputs$uHealthyStatin,\n                             uPenaltyMildStatinAdverse = inputs$uPenaltyMildStatinAdverse,\n                             uPenaltyMajorStatinAdverse = inputs$uPenaltyMajorStatinAdverse)\n  \n  patientWcea = cbind(traces, cost_util)\n  \n  return(patientWcea)\n}\n\n# output is the ICER\n\nRIPS_CVD_run = function(inputs){\n  \n  patientWcea = RIPS_CVD_data(inputs)\n  \n  strategyWcea = patientWcea %>% \n    group_by(strategy) %>%\n      summarize(\n        time_in_model = mean(time_in_model),\n        cost = mean(cost_disc), \n        QALY = mean(util_disc)) %>%\n    mutate(strategy = ifelse(strategy == 1, \"Statins(2013 ACC/AHA)\", \"Status Quo\"))\n\n  df_cea = calculate_icers(cost = strategyWcea$cost,\n                         effect = strategyWcea$QALY,\n                         strategies = strategyWcea$strategy) %>%\n    left_join(strategyWcea %>% select(Strategy = strategy, LE = time_in_model))\n\n  return(df_cea)\n}\n\nstrategy_compare = function(patientWcea){\n  strategyWcea = patientWcea %>% \n    group_by(strategy) %>%\n    summarize(\n      time_in_model = mean(time_in_model),\n      cost = mean(cost_disc), \n      QALY = mean(util_disc)) %>%\n    mutate(strategy = ifelse(strategy == 1, \"Treatment\", \"Status Quo\"))\n  \n  df_cea = calculate_icers(cost = strategyWcea$cost,\n                           effect = strategyWcea$QALY,\n                           strategies = strategyWcea$strategy) %>%\n    left_join(strategyWcea %>% select(Strategy = strategy, LE = time_in_model)) %>%\n    mutate(NHB = Effect - Cost/100000)\n  \n  return(df_cea)\n}\n```\n:::\n\n\n\n# Abstract Body\n\n**Purpose:** Disease simulation techniques, notably microsimulation and discrete event simulation (DES) models, often are challenged with stochastic noise. This noise can mask true differences between strategies and increase both time and resource costs. Despite the extensive application of Common Random Numbers (CRNs), a variance reduction technique, in microsimulation models, their use in DES for disease modeling remains under-explored. To our knowledge, no study has yet explicitly outlined the steps to incorporate CRNs into DES for disease modeling or quantified the resulting efficiency gains. We aim to bridge this research gap and demonstrate the benefits of CRNs in DES for disease modeling.\n\n**Methods:** We developed a DES model to evaluate the cost-effectiveness of statin treatment in people aged 40 to 80 in the US at risk of atherosclerotic cardiovascular disease (ASCVD) over a lifetime horizon.The model cohort was populated with the National Health and Nutrition Examination Survey, and parameters were informed from published literature. We compared the incremental net health benefit (iNHB) of statins under two scenarios -- with and without the use of CRNs -- across a broad range of model cohort sizes. To implement CRNs, we assigned each potential event a patient-specific and event-specific random number that remained consistent across model runs to determine the event occurrence and time to event. Unique to DES, the use of CRNs in our model involved the inverse cumulative distribution function, which transformed CRNs (standard uniform random draws between 0 and 1) into non-uniform quantiles that were used to represent time variables.\n\n**Results:** Figure Panel A demonstrates that the use of CRNs led to a monotonic function in the model output, where a lower relative risk consistently resulted in a higher iNHB of statins, effectively reducing noise. Panel B indicates that integrating CRNs within DES resulted in faster stabilization of the model-estimated iNHB around the true value with smaller sample sizes, thereby enhancing efficiency.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nload(\"data/rrStatinsASCVD501.RData\")\n\nwoCRN = all_woCRN %>% filter(Strategy == \"Statins(2013 ACC/AHA)\") %>% left_join(all_woCRN %>% filter(Strategy == \"Status Quo\"), by = c(\"rrStatinsASCVD\", \"time\"), suffix = c(\"_statins\", \"_quo\")) %>%\n  mutate(INHB = NHB_statins - NHB_quo,\n         group = 0)\n\nwCRN = all_wCRN %>% filter(Strategy == \"Statins(2013 ACC/AHA)\") %>% left_join(all_wCRN %>% filter(Strategy == \"Status Quo\"), by = c(\"rrStatinsASCVD\", \"time\"), suffix = c(\"_statins\", \"_quo\")) %>%\n  mutate(INHB = NHB_statins - NHB_quo,\n         group = 1)\n\nrr501 = rbind(woCRN, wCRN) %>%\n  mutate(group = factor(group, levels = 0:1, labels = c(\"without CRNs\", \"with CRNs\")))\n\nrrStatins501 = \n  rr501 %>%\n  ggplot(aes(x = rrStatinsASCVD, y = INHB)) +\n  geom_point(size = 1) +\n  geom_smooth(alpha = 0.5) +\n  facet_wrap(. ~ group) +\n  labs(x = \"Statin treatment efficacy, RR of incident ASCVD\", y = \"Incremental Net Health Benefit (in QALYs)\") +\n  theme_bw() +\n  scale_x_continuous(labels = scales::comma)\n\nload(\"data/converge100k.RData\")\n\nconverge_wCRN = strategy_compare(patients_wCRN[1:20,])\nconverge_woCRN = strategy_compare(patients_woCRN[1:20,])\n\nfor (size in round(10^(seq(1.25, 5, by = 0.25)))){\n  converge_wCRN = rbind(converge_wCRN, strategy_compare(patients_wCRN[1:(2*size),]))\n  converge_woCRN = rbind(converge_woCRN, strategy_compare(patients_woCRN[1:(2*size),]))\n}\n\nconverge_wCRN$nPop = rep(round(10^seq(1, 5, by = 0.25)), each = 2)\nconverge_woCRN$nPop = rep(round(10^seq(1, 5, by = 0.25)), each = 2)\n\nconverge_wCRN$nPopLog = rep(seq(1,5,by = 0.25), each = 2)\nconverge_woCRN$nPopLog = rep(seq(1,5,by = 0.25), each = 2)\n\nconverge_wCRN$group = 1\nconverge_woCRN$group = 0\n\nconverge = rbind(converge_woCRN, converge_wCRN) %>%\n  mutate(group = factor(group, levels = 0:1, labels = c(\"without CRNs\", \"with CRNs\")),\n         Strategy = ifelse(Strategy == \"Status Quo\", \"No Treatment\", \"Statin Treatment\"))\n\nconverge100k = converge %>%\n  ggplot(aes(x = nPopLog, y = NHB, color = Strategy)) +\n  geom_line() +\n  facet_grid(. ~ group) +\n  scale_x_continuous(labels = 10^seq(1:5)) + \n  scale_color_manual(values = c(\"#AC3931\", \"#6699ff\")) +\n  labs(x = \"Sample Size\", y = \"Net Health Benefit (in QALYs)\") +\n  theme_bw()\n\nlibrary(ggpubr)\n\n# ggarrange(rrStatins501, converge100k,\n#                    legend = \"bottom\",\n#                    nrow = 2, heights = c(0.45, 0.55),\n#                    labels = \"AUTO\")\n\nrrStatins501\n```\n\n::: {.cell-output-display}\n![](CVD_DES_CRN_abstract_files/figure-html/abstract-1.png){width=672}\n:::\n\n```{.r .cell-code}\nconverge100k\n```\n\n::: {.cell-output-display}\n![](CVD_DES_CRN_abstract_files/figure-html/abstract-2.png){width=672}\n:::\n:::\n\n\n**Conclusion:** Previous studies have established DES as a more efficient alternative to microsimulation for disease simulation modeling. Our findings reinforce this advantage, suggesting that when DES is further augmented with CRNs, it can achieve even greater efficiency. With less stochastic noise and faster convergence, this increased efficiency can enable more computationally intensive tasks, such as probabilistic sensitivity analysis, model calibration, and value of information analysis.\n\n# Model Body\n\n## Inputs\n\nSpahillari, et al. (2020)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nknitr::opts_chunk$set(eval = FALSE)\n\nparams = list(\n  ## basic/general from Stroke paper, 2023\n  strategy = 0, # or 1\n  vN = 1000,\n  vHorizon = 100, # all people should terminate before horizon\n  discount_rate = 0.03,\n  wtp = 100000,\n  CPI2017 = 245.12,\n  CPI2019 = 255.657,\n  CPI2020 = 258.811,\n  \n  ## events from paper 2017\n  rrStatinsASCVD = 0.79,\n  rrStatinsASCVD_low = 0.77,\n  rrStatinsASCVD_upp = 0.81,\n  rrStatinsASCVD_dist = \"lognormal\",\n  \n  hrAfterASCVD = 1.9,\n  hrAfterASCVD_low = 1.60,\n  hrAfterASCVD_upp = 2.40, \n  hrAfterASCVD_dist = \"lognormal\", # log-normal\n  \n  mortalityFirstYearASCVD_female_young = 0.09,\n  mortalityFirstYearASCVD_female_young_dist = \"beta\",\n  \n  mortalityFirstYearASCVD_female_old = 0.3,\n  mortalityFirstYearASCVD_female_old_dist = \"beta\",\n  \n  mortalityFirstYearASCVD_male_young = 0.14,\n  mortalityFirstYearASCVD_male_young_dist = \"beta\",\n  \n  mortalityFirstYearASCVD_male_old = 0.25,\n  mortalityFirstYearASCVD_male_old_dist = \"beta\",\n  \n  pMildStatinAdverse = 0.047,\n  pMildStatinAdverse_low = 0.047*0.85, \n  pMildStatinAdverse_upp = 0.047*1.15,\n  pMildStatinAdverse_dist = \"beta\",\n  \n  pMajorStatinAdverse = 0.006/100,\n  pMajorStatinAdverse_low = 0.006/100*0.85,\n  pMajorStatinAdverse_upp = 0.006/100*1.15,\n  pMajorStatinAdverse_dist = \"beta\",\n  \n  pMajorStatinAdverseBeingFatal = 0.09/100,\n  pMajorStatinAdverseBeingFatal_low = 0.09/100*0.85,\n  pMajorStatinAdverseBeingFatal_upp = 0.09/100*1.15,\n  pMajorStatinAdverseBeingFatal_dist = \"beta\",\n\n  ## utility\n  uHealthy = 1,\n  uAfterASCVD = 0.773,\n  uAfterASCVD_low = 0.773*0.85,\n  uAfterASCVD_upp = 0.773*1.15,\n  uAfterASCVD_dist = \"beta\",\n  \n  uHealthyStatin = 0.996,\n  uHealthyStatin_low = 0.991,\n  uHealthyStatin_upp = 1.000,\n  uHealthyStatin_dist = \"beta\",\n  \n  uPenaltyMildStatinAdverse = -0.0055,\n  uPenaltyMajorStatinAdverse = -0.0383,\n  \n  uDeath = 0,\n  \n  ## cost(2017)\n  cAnnualFU_afterASCVD = 3917,\n  cAnnualFU_afterASCVD_low = 2611,\n  cAnnualFU_afterASCVD_upp = 6528,\n  cAnnualFU_afterASCVD_dist = \"gamma\",\n  \n  cNonFatalASCVD = 49348,\n  cNonFatalASCVD_low = 49348*0.85,\n  cNonFatalASCVD_upp = 49348*1.15,\n  cNonFatalASCVD_dist = \"gamma\",\n  \n  cFatalASCVD = 16760,\n  cFatalASCVD_low = 16760*0.85,\n  cFatalASCVD_upp = 16760*1.15,\n  cFatalASCVD_dist = \"gamma\",\n  \n  cAnnualStatin = 84,\n  \n  cMildStatinAdverse = 215,\n  cMildStatinAdverse_low = 196,\n  cMildStatinAdverse_upp = 326,\n  cMildStatinAdverse_dist = \"gamma\",\n  \n  cMajorStatinAdverse = 8486,\n  cMajorStatinAdverse_low = 6920, \n  cMajorStatinAdverse_upp = 10314,\n  cMajorStatinAdverse_dist = \"gamma\",\n  \n  annual_discount_rate = 0.03,\n  \n  ### sourceï¼šAgency for Healthcare Research and Quality. Mean expenditure per person by age groups, United States, 1996 to 2020. Medical Expenditure Panel Survey.(2020)\n  cHealthcareNonCVD_18_44 = 3901,\n  cHealthcareNonCVD_45_64 = 8693,\n  cHealthcareNonCVD_65 = 12441\n\n)\n## inflation\nparams$rInflation2017 = params$CPI2020 / params$CPI2017\nparams$rInflation2019 = params$CPI2020 / params$CPI2019\n\n## leave some spaces for PSA\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# simply change from prob to rate than to event\nProbToRate = function(prob, t){\n  -log(1-prob)/t\n}\n\nRateToProb = function(rate, t){\n  1 - exp(-rate*t)\n}\n# # what this t should be -- 10 years?\n# # time unit: year\n# rate = ProbToRate(pcr()/100)\n# days = rexp(1,rate)\n\ndiscounted <- function(undiscounted, start_year, end_year, rate = params$annual_discount_rate)\n{\n  undiscounted / log(1 + rate) * (1 / (1+rate)^start_year - 1/ (1+rate)^end_year)\n}\n\ndiscount <- function(value, A, ar=params$annual_discount_rate) value / (1+ar)^A\n```\n:::\n\n\n## Random Number Generator\n\nattributes and events for random:\n\n| location                     | attributes/events    | without CRN                                                                                  | with CRN                                                                                                                                        |\n|------------------|------------------|------------------|-------------------|\n| initialize_patient           | **nhanesNo**         | sample(1:nrow(nhanes_pop), 1, prob=1/nhanes_pop\\$WTMEC2YR))                                  | nhanes_pop\\$cum_weight = cumsum(nhanes_pop\\$WTMEC2YR / sum(nhanes_pop\\$WTMEC2YR))                                                               |\n| years_till_death_without_CVD | **aDeathWithoutCVD** | rgompertz(1, shape, rate)                                                                    | qgompertz(inputs\\$randomNums\\[(get_attribute(env,\"patientID\"))\\*length(rCRN) + rCRN\\[\"rDeathWithoutCVD\"\\]\\], shape, rate)                       |\n| years_till_get_CVD           | **aGetCVD**          | rexp(1,ProbToRate(prob, 10))                                                                 | qexp(inputs\\$randomNums\\[(get_attribute(env,\"patientID\"))\\*length(rCRN) + rCRN\\[\"rGetCVD\"\\]\\], ProbToRate(prob, 10))                            |\n| years_till_death_of_ASCVD    | **aDeathOfASCVD**    | sample(0:1, 1, prob = c(1-inputs\\$mortalityFirstYearASCVD, inputs\\$mortalityFirstYearASCVD)) | ifelse(inputs\\$randomNums\\[(get_attribute(env,\"patientID\"))\\*length(rCRN) + rCRN\\[\"rDeathOfASCVD\"\\]\\] \\< inputs\\$mortalityFirstYearASCVD, 1, 0) |\n| years_till_death_after_ASCVD | **aDeathAfterASCVD** | rgompertz(1, shape, rate)                                                                    | qgompertz(inputs\\$randomNums\\[(get_attribute(env,\"patientID\"))\\*length(rCRN) + rCRN\\[\"rDeathAfterASCVD\"\\]\\], shape, rate))                      |\n\nAlso, need to remind who this individual is inside the DES simulation: get_attribute(env, \"patientID\")\n\nCRN will also lead to the same result for the same event. Right now we just loop once, if more will set more CRN.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(114514)\nrCRN = 1:8\nnames(rCRN) = c(\"nhanesNo\", \"rDeathWithoutCVD\", \"rGetCVD\", \"rDeathOfASCVD\", \"rDeathAfterASCVD\", \"rStatinsMildAdverse\", \"rStatinsMajorAdverse\", \"rDeathOfStatinsAdverse\")\n\nparams_CRN = params\nparams_CRN$nRN = params_CRN$vN * length(rCRN)\nparams_CRN$randomNums = runif(params_CRN$nRN)\n```\n:::\n\n\n## Gompertz Model\n\nWe use Gompertz model based on US cause-deleted life table to predict the death age.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# source(\"nonCVD_life_table.R\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# # male\n# \n# mltNonCVD_long = data.frame(Age = rep(NA, ceiling(sum(mlt2020_nonCVD$dx))), Death = rep(1, ceiling(sum(mlt2020_nonCVD$dx))))\n# \n# start = 1\n# for (age in 0:(nrow(mlt2020_nonCVD)-1)) {\n#   n_row = round(mlt2020_nonCVD[age+1,\"dx\"])\n#   mltNonCVD_long[seq(start,(n_row + start - 1)),\"Age\"] = age\n#   start = start + n_row\n# }\n# \n# mltNonCVD_long = mltNonCVD_long %>% drop_na()\n# \n# parameters_m = data.frame(\n#   Age = mlt2020_nonCVD$Age,\n#   shape=rep(NA,nrow(mlt2020_nonCVD)),\n#   rate=rep(NA,nrow(mlt2020_nonCVD)))\n# \n# \n# for (age in 0:nrow(mlt2020_nonCVD)-1) {\n#   surv.data <- with(mltNonCVD_long[mltNonCVD_long$Age >= age,], Surv(Age, Death, origin=age))\n#   surv.model <- flexsurvreg(surv.data ~ 1, dist=\"gompertz\")\n# \n#   parameters_m$shape[age+1] <- surv.model$coefficients[1]\n#   parameters_m$rate[age+1] <- exp(surv.model$coefficients[2])\n# }\n# \n# # if start since 45-yr\n# # pgompertz(cycle, parameters_m$shape[46], parameters_m$rate[46])\n# \n# # female\n# \n# fltNonCVD_long = data.frame(Age = rep(NA, ceiling(sum(flt2020_nonCVD$dx))), Death = rep(1, ceiling(sum(flt2020_nonCVD$dx))))\n# \n# start = 1\n# for (age in 0:(nrow(flt2020_nonCVD)-1)) {\n#   n_row = round(flt2020_nonCVD[age+1,\"dx\"])\n#   fltNonCVD_long[seq(start,(n_row + start - 1)),\"Age\"] = age\n#   start = start + n_row\n# }\n# \n# fltNonCVD_long = fltNonCVD_long %>% drop_na()\n# \n# parameters_f = data.frame(\n#   Age = flt2020_nonCVD$Age,\n#   shape=rep(NA,nrow(flt2020_nonCVD)),\n#   rate=rep(NA,nrow(flt2020_nonCVD)))\n# \n# \n# for (age in 0:nrow(flt2020_nonCVD)-1) {\n#   surv.data <- with(fltNonCVD_long[fltNonCVD_long$Age >= age,], Surv(Age, Death, origin=age))\n#   surv.model <- flexsurvreg(surv.data ~ 1, dist=\"gompertz\")\n# \n#   parameters_f$shape[age+1] <- surv.model$coefficients[1]\n#   parameters_f$rate[age+1] <- exp(surv.model$coefficients[2])\n# }\n\nageAtDeath <- function(currentAge, gender, inputs, patientID)\n{\n  # patientID = get_attribute(env, \"patientID\")\n  currentAge_f <- floor(currentAge) #negative time to secular death issue\n  \n  # Male 1 FEMALE 2\n  if(gender == 2){\n    shape <- parameters_f$shape[currentAge_f+1]\n    rate  <- parameters_f$rate[currentAge_f+1]\n  } else {\n    shape <- parameters_m$shape[currentAge_f+1]\n    rate  <- parameters_m$rate[currentAge_f+1]\n  }\n  \n  min(currentAge + ifelse(is.null(inputs$randomNums), rgompertz(1, shape, rate), qgompertz(inputs$randomNums[(patientID-1)*length(rCRN) + rCRN[\"rDeathWithoutCVD\"]], shape, rate)), 100)\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# # male\n# mlt2020_hr = data.frame(Age = 0:(nrow(mlt2020_nonCVD)-1), qx = sapply(sapply(mlt2020_nonCVD$qx, ProbToRate, t = 1) * inputs$hrAfterASCVD, RateToProb, t = 1), lx = rep(0,nrow(mlt2020_nonCVD)), dx = rep(NA,nrow(mlt2020_nonCVD)))\n# \n# mlt2020_hr[1,\"lx\"] = 100000\n# \n# for (i in 1:nrow(mlt2020_hr)) {\n#   if (mlt2020_hr[i, \"lx\"] > 0) {\n#     mlt2020_hr[i, \"dx\"] = round(mlt2020_hr[i, \"qx\"] * mlt2020_hr[i, \"lx\"])\n#     mlt2020_hr[i+1, \"lx\"] = mlt2020_hr[i, \"lx\"] - mlt2020_hr[i, \"dx\"]\n#   }\n# }\n# mlt2020_hr  = mlt2020_hr %>% filter(!is.na(dx))\n# \n# mltHr_long = data.frame(Age = rep(NA, 100000), Death = rep(1, 100000))\n# \n# start = 1\n# for (age in 0:(nrow(mlt2020_hr)-1)) {\n#   n_row = mlt2020_hr[age+1,\"dx\"]\n#   mltHr_long[seq(start,(n_row + start - 1)),\"Age\"] = age\n#   start = start + n_row\n# }\n# \n# parameters_m_hr = data.frame(\n#   Age = mlt2020_hr$Age,\n#   shape=rep(NA,nrow(mlt2020_hr)),\n#   rate=rep(NA,nrow(mlt2020_hr)))\n# \n# for (age in 0:nrow(mlt2020_hr)-1) {\n#   surv.data <- with(mltHr_long[mltHr_long$Age >= age,], Surv(Age, Death, origin=age))\n#   surv.model <- flexsurvreg(surv.data ~ 1, dist=\"gompertz\")\n# \n#   parameters_m_hr$shape[age+1] <- surv.model$coefficients[1]\n#   parameters_m_hr$rate[age+1] <- exp(surv.model$coefficients[2])\n# }\n# \n# # female\n# \n# flt2020_hr = data.frame(Age = 0:(nrow(flt2020_nonCVD)-1), qx = sapply(sapply(flt2020_nonCVD$qx, ProbToRate, t = 1) * inputs$hrAfterASCVD, RateToProb, t = 1), lx = rep(0,nrow(flt2020_nonCVD)), dx = rep(NA,nrow(flt2020_nonCVD)))\n# \n# flt2020_hr[1,\"lx\"] = 100000\n# \n# for (i in 1:nrow(flt2020_hr)) {\n#   if (flt2020_hr[i, \"lx\"] > 0) {\n#     flt2020_hr[i, \"dx\"] = round(flt2020_hr[i, \"qx\"] * flt2020_hr[i, \"lx\"])\n#     flt2020_hr[i+1, \"lx\"] = flt2020_hr[i, \"lx\"] - flt2020_hr[i, \"dx\"]\n#   }\n# }\n# flt2020_hr  = flt2020_hr %>% filter(!is.na(dx))\n# \n# fltHr_long = data.frame(Age = rep(NA, 100000), Death = rep(1, 100000))\n# \n# start = 1\n# for (age in 0:(nrow(flt2020_hr)-1)) {\n#   n_row = flt2020_hr[age+1,\"dx\"]\n#   fltHr_long[seq(start,(n_row + start - 1)),\"Age\"] = age\n#   start = start + n_row\n# }\n# \n# parameters_f_hr = data.frame(\n#   Age = flt2020_hr$Age,\n#   shape=rep(NA,nrow(flt2020_hr)),\n#   rate=rep(NA,nrow(flt2020_hr)))\n# \n# for (age in 0:nrow(flt2020_hr)-1) {\n#   surv.data <- with(fltHr_long[fltHr_long$Age >= age,], Surv(Age, Death, origin=age))\n#   surv.model <- flexsurvreg(surv.data ~ 1, dist=\"gompertz\")\n# \n#   parameters_f_hr$shape[age+1] <- surv.model$coefficients[1]\n#   parameters_f_hr$rate[age+1] <- exp(surv.model$coefficients[2])\n# }\n# \nageAtDeath_afterASCVD = function(currentAge, gender, inputs, patientID)\n{\n  # patientID = get_attribute(env,\"patientID\")\n  currentAge_f <- floor(currentAge) #negative time to secular death issue\n\n  # Male 1 FEMALE 2\n  if(gender == 2)\n  {\n    shape <- parameters_f_hr$shape[currentAge_f+1]\n    rate  <- parameters_f_hr$rate[currentAge_f+1]\n    age = min(currentAge + ifelse(is.null(inputs$randomNums), rgompertz(1, shape, rate), qgompertz(inputs$randomNums[(patientID-1)*length(rCRN) + rCRN[\"rDeathAfterASCVD\"]], shape, rate)), max(parameters_f_hr$Age))\n  }\n  else\n  {\n    shape <- parameters_m_hr$shape[currentAge_f+1]\n    rate  <- parameters_m_hr$rate[currentAge_f+1]\n    age = min(currentAge + ifelse(is.null(inputs$randomNums), rgompertz(1, shape, rate), qgompertz(inputs$randomNums[(patientID-1)*length(rCRN) + rCRN[\"rDeathAfterASCVD\"]], shape, rate)), max(parameters_m_hr$Age))\n  }\n\n  age\n}\n# \n# save(parameters_f, parameters_m, parameters_f_hr, parameters_m_hr, file = \"life table/MarkovCVD_gompertz.RData\")\n\n# load(\"life table/MarkovCVD_gompertz.RData\")\n```\n:::\n\n\n## PCE\n\nWe use the pooled cohort equation to calculate the risk of CVD from risk factors.\n\n<https://github.com/spgarbet/desdt/tree/main/framingham>\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# source('pcr.R')\n# # the probability are percents!!\n```\n:::\n\n\n## Sample population\n\nWe use NHANES study for the simulated population (limited by the PCE limits).\n\nUse the 2017-2018 version: <https://wwwn.cdc.gov/nchs/nhanes/continuousnhanes/default.aspx?BeginYear=2017>\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ## SEQN: Respondent sequence number\n# # Examination: Body Measures\n# ## BMXBMI - Body Mass Index (kg/m**2)\n# ## 12.3 to 86.2\tRange of Values\n# ## .\tMissing\n# nhanes_data_1 = data.frame(read_xpt(\"./NHANES/BMX_J.XPT\", col_select = c(\"SEQN\",\"BMXBMI\")))\n# # Lab: Glycohemoglobin\n# ## LBXGH: Glycohemoglobin (%)\n# nhanes_data_2 = data.frame(read_xpt(\"./NHANES/GHB_J.XPT\", col_select = c(\"SEQN\",\"LBXGH\")))\n# # Examination: Blood Pressure\n# ## BPXSY1 - Systolic: Blood pres (1st rdg) mm Hg\n# ## BPXDI1 - Diastolic: Blood pres (1st rdg) mm Hg\n# ## 0 to 136\tRange of Values\n# ## .\tMissing\n# nhanes_data_3 = data.frame(read_xpt(\"./NHANES/BPX_J.XPT\", col_select = c(\"SEQN\",\"BPXDI1\",\"BPXSY1\")))\n# # Demographic Variables and Sample Weights\n# ## RIAGENDR - Gender\n# ## 1\tMale\n# ## 2\tFemale\t\n# ## .\tMissing\n# ## RIDAGEYR - Age in years at screening\n# ## 0 to 79\tRange of Values\n# ## 80\t80 years of age and over\n# ## .\tMissing\n# \n# ## RIDRETH1 - Race/Hispanic origin\n# ## 1\tMexican American\t1367\t1367\t\n# ## 2\tOther Hispanic\t820\t2187\t\n# ## 3\tNon-Hispanic White\t3150\t5337\t\n# ## 4\tNon-Hispanic Black\t2115\t7452\t\n# ## 5\tOther Race - Including Multi-Racial\t1802\t9254\t\n# ## .\tMissing\n# \n# ## WTMEC2YR - Full sample 2 year MEC exam weight\n# ## 2566.1838545 to 419762.83649\tRange of Values\n# ## 0\tNot MEC Examined\n# ## .\tMissing\n# nhanes_data_4 = data.frame(read_xpt(\"./NHANES/DEMO_J.XPT\", col_select = c(\"SEQN\",\"RIDAGEYR\",\"RIAGENDR\",\"RIDRETH1\",\"WTMEC2YR\"))) #WTMEC2YR is the sample weights variable\n# # Questionnaire: Diabetes\n# ## DIQ010 - Doctor told you have diabetes\n# ## 1\tYes\n# ## 2\tNo\n# ## 3\tBorderline\n# ## 7\tRefused\n# ## 9\tDon't know\n# ## .\tMissing\n# nhanes_data_5 = data.frame(read_xpt(\"./NHANES/DIQ_J.XPT\", col_select = c(\"SEQN\",\"DIQ010\")))\n# # Lab: Cholesterol - High - Density Lipoprotein\n# ## LBDHDD: Direct HDL-Cholesterol (mg/dL)\n# nhanes_data_6 = data.frame(read_xpt(\"./NHANES/HDL_J.XPT\", col_select = c(\"SEQN\",\"LBDHDD\")))\n# # Questionnaire: medical conditions\n# ## MCQ160d: Ever told you had angina/angina pectoris\n# ## MCQ160e: Ever told you had heart attack\n# ## MCQ160f: Ever told you had a stroke\n# ## 1\tYes\n# ## 2\tNo\n# ## 7\tRefused\t\n# ## 9\tDon't know\n# ## .\tMissing\n# nhanes_data_7 = data.frame(read_xpt(\"./NHANES/MCQ_J.XPT\", col_select = c(\"SEQN\",\"MCQ160D\",\"MCQ160F\",\"MCQ160E\")))\n# # Questionnaire: Smoking - Cigarette Use\n# ## SMQ040: Do you now smoke cigarettes?\n# ## 1\tEvery day\n# ## 2\tSome days\n# ## 3\tNot at all\t\n# ## 7\tRefused\n# ## 9\tDon't know\n# ## .\tMissing\n# nhanes_data_8 = data.frame(read_xpt(\"./NHANES/SMQ_J.XPT\", col_select = c(\"SEQN\",\"SMQ040\")))\n# # Lab: Cholesterol - Total\n# ## LBXTC: Total Cholesterol (mg/dL)\n# nhanes_data_9 = data.frame(read_xpt(\"./NHANES/TCHOL_J.XPT\", col_select = c(\"SEQN\",\"LBXTC\")))\n# nhanes_data_10 = data.frame(read_xpt(\"./NHANES/BPQ_J.XPT\", col_select = c(\"SEQN\", \"BPQ050A\")))\n# # Lab: Cholesterol - Low-Density Lipoproteins (LDL)\n# ## LBDLDL - LDL-Cholesterol, Friedewald (mg/dL)\n# nhanes_data_11 = data.frame(read_xpt(\"./NHANES/TRIGLY_J.XPT\", col_select = c(\"SEQN\", \"LBDLDL\")))\n# \n# nhanes_data_raw <- list(nhanes_data_1,nhanes_data_2,nhanes_data_3,nhanes_data_4,\n#                         nhanes_data_5,nhanes_data_6,nhanes_data_7,nhanes_data_8,\n#                         nhanes_data_9,nhanes_data_10,nhanes_data_11)\n# nhanes_data_raw <- data.frame(reduce(nhanes_data_raw, full_join, by='SEQN'))\n# nhanes_pop = nhanes_data_raw %>%\n#   # whether needs to check missing data\n#   filter(WTMEC2YR != 0 & RIDAGEYR >= 40 & RIDAGEYR <= 79 & LBXTC >= 30 & LBXTC <= 500 & LBDHDD >= 5 & LBDHDD <= 200 & BPXSY1 >= 60 & BPXSY1 <= 200) %>%\n#   drop_na() %>%\n#   mutate(RIDRETH1 = ifelse(RIDRETH1 == 3, 1, ifelse(RIDRETH1 == 4, 2, ifelse(RIDRETH1 %in% c(1,2), 3, 4))))\n# \n# nhanes_pop$cum_weight = cumsum(nhanes_pop$WTMEC2YR / sum(nhanes_pop$WTMEC2YR))\n# \nrace = 1:4\nnames(race) = c(\"White\", \"African American\", \"Hispanic\", \"Other\")\nrace_convert = function(num) {\n  return(names(race[num]))\n}\n\nbp_treatment = 1:2\nnames(bp_treatment) = c(\"Yes\",\"No\")\n\nsmoker = 1:3\nnames(smoker) = c(\"Every day\",\"Some days\",\"Not at all\")\n\ndiabetic = 1:2\nnames(diabetic) = c(\"Yes\",\"No\")\n# \n# save(nhanes_pop, nhanes_data_raw, file = \"./NHANES/nhanes_full.RData\")\n\n# load(\"./NHANES/nhanes_full.RData\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# for CRN, add an identifier\ninitialize_patient <- function(traj, inputs)\n{\n        traj %>%\n                seize(\"time_in_model\")       %>%\n                set_attribute(\"patientID\", function()\n                  # patientID is 0-index\n                  as.numeric(str_remove(get_name(env), \"patient\"))) %>%\n                # NHANES version\n                set_attribute(\"nhanesNo\",         function() ifelse(\n                  is.null(inputs$randomNums),\n                  sample(1:nrow(nhanes_pop), 1, prob=nhanes_pop$WTMEC2YR),\n                  which(nhanes_pop$cum_weight>=inputs$randomNums[(get_attribute(env,\"patientID\"))*length(rCRN) + rCRN[\"nhanesNo\"]])[1])) %>%\n                set_attribute(\"Gender\",     function() nhanes_pop$RIAGENDR[get_attribute(env, \"nhanesNo\")]) %>%\n                set_attribute(\"Age\",        function() nhanes_pop$RIDAGEYR[get_attribute(env, \"nhanesNo\")]) %>% \n                set_attribute(\"AgeInitial\", function() get_attribute(env, \"Age\")) %>%\n                set_attribute(\"Race\",       function() nhanes_pop$RIDRETH1[get_attribute(env, \"nhanesNo\")]) %>%\n                set_attribute(\"TotChol\",    function() nhanes_pop$LBXTC[get_attribute(env, \"nhanesNo\")]) %>%\n                set_attribute(\"HdlChol\",    function() nhanes_pop$LBDHDD[get_attribute(env, \"nhanesNo\")]) %>%\n                set_attribute(\"LdlChol\",   function()\nnhanes_pop$LBDLDL[get_attribute(env, \"nhanesNo\")]) %>%\n                set_attribute(\"SystolicBp\", function() nhanes_pop$BPXSY1[get_attribute(env, \"nhanesNo\")]) %>%\n                set_attribute(\"BpTreatment\",function() nhanes_pop$BPQ050A[get_attribute(env, \"nhanesNo\")]) %>%\n                set_attribute(\"Smoker\",      function() nhanes_pop$SMQ040[get_attribute(env, \"nhanesNo\")]) %>%\n                set_attribute(\"Diabetic\",    function() nhanes_pop$DIQ010[get_attribute(env, \"nhanesNo\")]) %>%\n                set_attribute(\"PrsZ\",       function() 0) %>%\n                set_attribute(\"PCErisk\",    function()\n  pcr(gender = ifelse(get_attribute(env, \"Gender\") == 1, 'M', 'F'),\n             get_attribute(env,\"AgeInitial\"),\n             race_convert(get_attribute(env, \"Race\")),\n             get_attribute(env, \"TotChol\"),\n             get_attribute(env, \"HdlChol\"),\n             get_attribute(env, \"SystolicBp\"),\n             (get_attribute(env, \"BpTreatment\") == 1),\n             (get_attribute(env, \"Smoker\") %in% c(1,2)),\n             (get_attribute(env, \"Diabetic\") == 1),\n             get_attribute(env, \"PrsZ\")\n             )[1]/100) %>%\n                set_attribute(\"Strategy\", function() inputs$strategy) %>%\n                set_attribute(\"aUseStatins\", function()\n                  ifelse(get_attribute(env, \"Strategy\") == 1 &\n                           (get_attribute(env, \"LdlChol\") >= 190 |\n                            get_attribute(env, \"PCErisk\") >= 0.075 |\n                            get_attribute(env, \"Diabetic\") == 1), 1, 0))\n}\n```\n:::\n\n\n# Intervention\n\nstrategy 0. status quo(placebo)\n\nstrategy 1. add statins as 2013 ACC/AHA\n\nIndividuals(\\>= 40 yr):\n\n-   with diabetes, or\n\n-   low-density lipoprotein cholesterol level \\>= 190 mg/dl, or\n\n-   estimated 10-year ASCVD risk greater than or equal to 7.5%.\n\nStatins will be taken until the ASCVD happen.\n\nAdverse events:\n\nAdverse events will happen immediately after using statins. The major adverse event will overlap the mild adverse event. The death caused by the major adverse event should happen immediately after the event.\n\n# DES\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncounters = c(\"get_CVD\", \"death_without_CVD\", \"death_of_ASCVD\", \"death_after_ASCVD\", \"statins_mild_adverse_event\", \"statins_major_adverse_event\", \"death_of_statins_adverse_event\", \"time_in_model\")\n\n### Note:\n### As only simulate all the things once, lots of places I use the initial age instead of the updated age. \n\nterminate <- function(traj, inputs)\n{\n  traj %>%\n  branch(function() 1,\n         continue=FALSE,\n         trajectory()               %>%\n           release(\"time_in_model\") %>%\n           timeout(0)\n        )\n}\n\n# # Statins events\n# years_till_use_statins <- function(inputs){\n#   ifelse(get_attribute(env, \"Strategy\") == 1 &\n#                            (get_attribute(env, \"LdlChol\") >= 190 |\n#                             get_attribute(env, \"PCErisk\") >= 0.075 |\n#                             get_attribute(env, \"Diabetic\") == 1), 0, Inf)\n# }\n# \n# event_use_statins <- function(traj, inputs){\n#   traj %>%\n#     mark(\"use_statins\")\n# }\n\nyears_till_statins_mild_adverse <- function(inputs){\n  if (get_attribute(env, \"aUseStatins\") == 1 & is.na(get_attribute(env, \"aStatinsMildAdverse\"))) {\n      ifelse(is.null(inputs$randomNums),\n      ifelse(runif(1)<inputs$pMildStatinAdverse,0, Inf),\n      ifelse(inputs$randomNums[(get_attribute(env,\"patientID\"))*length(rCRN) + rCRN[\"rStatinsMildAdverse\"]]<inputs$pMildStatinAdverse, 0, Inf)\n      )\n  } else Inf\n}\n\nevent_statins_mild_adverse <- function(traj, inputs){\n  traj %>% \n    mark(\"statins_mild_adverse_event\")\n}\n\nyears_till_statins_major_adverse <- function(inputs){\n  if (get_attribute(env, \"aUseStatins\") == 1 & is.na(get_attribute(env, \"aStatinsMajorAdverse\"))) {\n      ifelse(is.null(inputs$randomNums),\n      ifelse(runif(1)<inputs$pMajorStatinAdverse,0, Inf),\n      ifelse(inputs$randomNums[(get_attribute(env,\"patientID\"))*length(rCRN) + rCRN[\"rStatinsMajorAdverse\"]]<inputs$pMajorStatinAdverse, 0, Inf)\n      )\n  } else Inf\n}\n\nevent_statins_major_adverse <- function(traj, inputs){\n  traj %>% \n    mark(\"statins_major_adverse_event\")\n}\n\nyears_till_death_of_statins_adverse <- function(inputs){\n  time_to_major_adverse = get_attribute(env, \"aStatinsMajorAdverse\")\n  if (!is.infinite(time_to_major_adverse)){\n    ifelse(is.null(inputs$randomNums),\n    ifelse(runif(1)<inputs$pMajorStatinAdverseBeingFatal, time_to_major_adverse +0, Inf),\n    ifelse(inputs$randomNums[(get_attribute(env,\"patientID\"))*length(rCRN) + rCRN[\"rDeathOfStatinsAdverse\"]] < inputs$pMajorStatinAdverseBeingFatal, time_to_major_adverse+0, Inf))\n  } else Inf\n}\n\nevent_death_of_statins_adverse <- function(traj, inputs){\n   traj %>% \n    set_attribute(\"AgeDeathStatinsAdverse\", function() get_attribute(env,\"aDeathOfStatinsAdverse\") + get_attribute(env,\"AgeInitial\")) %>%\n    branch(\n    function() 1,\n    continue=c(TRUE),\n    trajectory(\"Death associated with major adverse events\") %>%\n      mark(\"death_of_statins_adverse_event\") %>%\n      terminate(inputs)\n  )\n}\n\n## CVD events\n\nyears_till_death_without_CVD <- function(inputs)\n{\n  age       <- get_attribute(env, 'Age')\n  gender    <- get_attribute(env, 'Gender')\n  patientID <- get_attribute(env, 'patientID')\n  \n  deathAge = ageAtDeath(age, gender, inputs, patientID)\n  \n  ## the if-else here make sure that if get CVD firstly, will never die of 1.0 BG mortality\n  \n  return(ifelse(get_attribute(env, \"aGetCVD\") < deathAge - age, Inf, deathAge - age))\n}\n\nevent_death_without_CVD <- function(traj, inputs)\n{\n  cat(\"event_Death() \", now(env), \"\\n\")\n  \n  traj %>% \n    set_attribute(\"AgeDeathNonCVD\", function() get_attribute(env,\"aDeathWithoutCVD\") + get_attribute(env,\"AgeInitial\")) %>%\n    branch(\n    function() 1,\n    continue=c(TRUE),\n    trajectory(\"Death without CVD\") %>%\n      mark(\"death_without_CVD\") %>%\n      terminate(inputs)\n  )\n}\n\nyears_till_get_CVD <- function(inputs)\n{\n  gender = ifelse(get_attribute(env, \"Gender\") == 1, \"M\", \"F\")\n  race_pcr = race_convert(get_attribute(env, \"Race\")) \n  \n  prob = get_attribute(env, \"PCErisk\")\n  useStatins = get_attribute(env, \"aUseStatins\")\n  rr = ifelse(useStatins == 1, inputs$rrStatinsASCVD, 1)\n  \n  # 10-year probability to 1-year rate\n  years = ifelse(is.null(inputs$randomNums), rexp(1,ProbToRate(prob, 10)*rr), qexp(inputs$randomNums[(get_attribute(env,\"patientID\"))*length(rCRN) + rCRN[\"rGetCVD\"]], ProbToRate(prob, 10)*rr))\n  \n  return(ifelse(is.na(get_attribute(env, \"aGetCVD\")), years, Inf))\n}\n\nevent_get_CVD = function(traj, inputs) {\n  cat(\"event_get_CVD() \", now(env), \"\\n\")\n\n  traj %>%\n    set_attribute(\"AgeCVD\", function() get_attribute(env,\"AgeInitial\") + get_attribute(env, \"aGetCVD\")) %>%\n    branch(\n    function() 1,\n    continue=c(TRUE),\n    trajectory(\"Get CVD\") %>%\n      mark(\"get_CVD\"))\n}\n\nyears_till_death_of_ASCVD = function(inputs) {\n  \n  ageCVD    <- get_attribute(env, 'aGetCVD') + get_attribute(env, \"AgeInitial\")\n  gender    <- get_attribute(env, 'Gender')\n  \n  ## getCVD maybe sth really big.\n  \n  age_max = ifelse(gender == 1, max(parameters_m_hr$Age), max(parameters_f_hr$Age))\n  \n  if (ageCVD >= age_max - 1) {\n    # not able to use ageAtDeath(ageCVD+1, gender)\n    years = get_attribute(env, 'aGetCVD')\n  } else {\n    ## ageCVD under the age limitation -- able to use gomepertz\n    # whether ASCVD died in first year happened\n    happen = 0\n    if (gender == 1) {\n      ## men\n      if (ageCVD < 65) {\n        happen = ifelse(is.null(inputs$randomNums),\n                        sample(0:1, 1, prob = c(1-inputs$mortalityFirstYearASCVD_male_young, inputs$mortalityFirstYearASCVD_male_young)),\n                        ifelse(inputs$randomNums[(get_attribute(env,\"patientID\"))*length(rCRN) + rCRN[\"rDeathOfASCVD\"]] < inputs$mortalityFirstYearASCVD_male_young, 1, 0))\n        } else {\n          happen = ifelse(is.null(inputs$randomNums),\n                        sample(0:1, 1, prob = c(1-inputs$mortalityFirstYearASCVD_male_old, inputs$mortalityFirstYearASCVD_male_old)),\n                        ifelse(inputs$randomNums[(get_attribute(env,\"patientID\"))*length(rCRN) + rCRN[\"rDeathOfASCVD\"]] < inputs$mortalityFirstYearASCVD_male_old, 1, 0))\n          }\n      } else {\n        ## women\n        if (ageCVD < 65) {\n          happen = ifelse(is.null(inputs$randomNums),\n                        sample(0:1, 1, prob = c(1-inputs$mortalityFirstYearASCVD_female_young, inputs$mortalityFirstYearASCVD_female_young)),\n                        ifelse(inputs$randomNums[(get_attribute(env,\"patientID\"))*length(rCRN) + rCRN[\"rDeathOfASCVD\"]] < inputs$mortalityFirstYearASCVD_female_young, 1, 0))\n          } else {\n            happen = ifelse(is.null(inputs$randomNums),\n                        sample(0:1, 1, prob = c(1-inputs$mortalityFirstYearASCVD_female_old, inputs$mortalityFirstYearASCVD_female_old)),\n                        ifelse(inputs$randomNums[(get_attribute(env,\"patientID\"))*length(rCRN) + rCRN[\"rDeathOfASCVD\"]] < inputs$mortalityFirstYearASCVD_female_old, 1, 0))\n          }\n      }\n    years = ifelse(happen == 1, get_attribute(env, \"aGetCVD\") + 0.5, Inf)\n  }\n  \n  return(years)\n}\n\nevent_death_of_ASCVD = function(traj, inputs) {\n  traj %>%\n    set_attribute(\"AgeDeathCVD\", function() get_attribute(env, \"AgeInitial\") + now(env)) %>%\n    branch(\n    function() 1,\n    continue=c(TRUE),\n    trajectory(\"Death of first-year ASCVD\") %>%\n      mark(\"death_of_ASCVD\") %>%\n      terminate(inputs)\n    )\n  }\n\nyears_till_death_after_ASCVD <- function(inputs) {\n  # whether die of ASCVD(in <= 1 yr)\n  if (is.infinite(get_attribute(env, 'aDeathOfASCVD'))) {\n  \n    ageCVD    <- get_attribute(env, 'aGetCVD') + get_attribute(env, \"AgeInitial\")\n    gender    <- get_attribute(env, 'Gender')\n    patientID <- get_attribute(env, 'patientID')\n\n    deathAge = ageAtDeath_afterASCVD(ageCVD + 1, gender, inputs, patientID)\n  \n    # GetCVD + ageInitial maybe a impossible number\n    years = deathAge - get_attribute(env, \"AgeInitial\")\n  \n  } else {\n    years = Inf\n  }\n  \n  return(years)\n}\n\nevent_death_after_ASCVD = function(traj, inputs) {\n  cat(\"event_death_with_CVD\", now(env), \"\\n\")\n  \n  traj %>% \n    set_attribute(\"AgeDeathCVD\", function() get_attribute(env, \"AgeInitial\")+now(env)) %>%\n    branch(\n    function() 1,\n    continue=c(TRUE),\n    trajectory(\"Death after ASCVD event\") %>%\n      mark(\"death_after_ASCVD\") %>%\n      terminate(inputs)\n    )\n}\n\nevent_registry <- list(\n        list(name          = \"Get CVD\",\n             attr          = \"aGetCVD\",\n             time_to_event = years_till_get_CVD,\n             func          = event_get_CVD,\n             reactive      = FALSE),\n        list(name          = \"Death without CVD\",\n             attr          = \"aDeathWithoutCVD\",\n             time_to_event = years_till_death_without_CVD,\n             func          = event_death_without_CVD,\n             reactive      = FALSE),\n        list(name          = \"Death of ASCVD\",\n             attr          = \"aDeathOfASCVD\",\n             time_to_event = years_till_death_of_ASCVD,\n             func          = event_death_of_ASCVD,\n             reactive      = FALSE),\n        list(name          = \"Death after ASCVD\",\n             attr          = \"aDeathAfterASCVD\",\n             time_to_event = years_till_death_after_ASCVD,\n             func          = event_death_after_ASCVD,\n             reactive      = FALSE),\n        list(name          = \"Halt at time horizon\",\n             attr          = \"aTerminate\",\n             time_to_event = function(inputs) inputs$vHorizon,\n             func          = terminate,\n             reactive      = FALSE),\n        # list(name          = \"Use Statins\",\n        #      attr          = \"aUseStatins\",\n        #      time_to_event = years_till_use_statins,\n        #      func          = event_use_statins,\n        #      reactive      = FALSE),\n        list(name          = \"Mild Adverse for Statins\",\n             attr          = \"aStatinsMildAdverse\",\n             time_to_event = years_till_statins_mild_adverse,\n             func          = event_statins_mild_adverse,\n             reactive      = FALSE),\n        list(name          = \"Major Adverse for Statins\",\n             attr          = \"aStatinsMajorAdverse\",\n             time_to_event = years_till_statins_major_adverse,\n             func          = event_statins_major_adverse,\n             reactive      = FALSE),\n        list(name          = \"Death of Major Adverse for Statins\",\n             attr          = \"aDeathOfStatinsAdverse\",\n             time_to_event = years_till_death_of_statins_adverse,\n             func          = event_death_of_statins_adverse,\n             reactive      = FALSE)\n)\n## aAgeCVD is not immediately(only get after this happen), but aGetCVD happens at 0.\n\n## in this way there'll be 2 aGetCVD\n## because if getCVD is inside the horizon, there'll be repeats. for the first version, they just died/terminated. \n```\n:::\n\n\n## run\n\nTwo versions of event_registry --\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# source(\"DES.R\")\n\nenv = simmer(\"CVD\")\n\nexec.simulation <- function(inputs)\n{\n        #set.seed(11451428)\n        env  <<- simmer(\"CVD\")\n        traj <- simulation(env, inputs)\n        env %>% create_counters(counters)\n        \n        env %>%\n                add_generator(\"patient\", traj, at(rep(0, inputs$vN)), mon=2) %>%\n                run(inputs$vHorizon+1e-6) %>% # Simulate just past horizon\n                wrap()\n        \n        get_mon_arrivals(env, per_resource = T)\n}\n```\n:::\n\n\n# Cost-Effectiveness Analysis\n\nAll events continues for 0s except time_in_model. Results only include all things that really happen.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# traces = results %>% filter(name %in% repeatNames2 & resource == \"get_CVD\") %>% group_by(name, resource) %>% summarize(start_time = min(start_time)) %>%\n#   rbind(results %>% filter(!(name %in% repeatNames2) | resource != \"get_CVD\") %>%\n#           filter(resource != \"time_in_model\") %>%\n#           select(name, resource, start_time)) %>%\n#   spread(key = resource, value= start_time) %>%\n#   full_join(results %>% filter(resource == \"time_in_model\") %>% mutate(time_in_model = activity_time) %>% select(name, time_in_model), by = \"name\") %>%\n#   left_join(casted %>% select(name, initial_age = aAgeInitial), by = \"name\")\n\n# traces %>% filter(get_CVD == death_of_ASCVD)\n\ntraces = results %>% select(-start_time, -activity_time, -replication) %>% spread(resource, end_time) %>% \n  left_join(casted %>% select(name, strategy, statins_use = aUseStatins, initial_age = AgeInitial), by = c(\"name\", \"strategy\"))\n\nif (is.null(traces$statins_major_adverse_event)) {traces$statins_major_adverse_event = NA}\n```\n:::\n\n\n##Status QUO CEA\n\n1.  never get CVD, never die before horizon.\\\n    **cost**: inputs\\$cHealthcareNonCVD \\* traces\\$time_in_model\\\n    **payoff**: inputs\\$uHealthy \\* traces\\$time_in_model\n\n2.  never get CVD, die of background mortality before horizon\\\n    **cost**: inputs\\$cHealthcareNonCVD \\* traces\\$time_in_model\\\n    **payoff**: inputs\\$uHealthy \\* traces\\$time_in_model\n\n3.  get CVD, survive till horizon\\\n    **cost**: inputs\\$cHealthcareNonCVD \\* traces\\$time_in_model + inputs\\$cNonFatalASCVD + inputs\\$cAnnualFU_afterASCVD \\* (traces\\$time_in_model - traces\\$get_CVD - 1)\\\n    **payoff**: inputs\\$uHealthy \\* traces\\$get_CVD + inputs\\$uAfterASCVD\\*(traces\\$time_in_model - traces\\$get_CVD)\n\n4.  get CVD, die of first-year ASCVD\\\n    **cost**: inputs\\$cHealthcareNonCVD \\* traces\\$time_in_model + inputs\\$cFatalASCVD\\\n    **payoff**: inputs\\$uHealthy \\* traces\\$get_CVD + inputs\\$uAfterASCVD\\*(traces\\$time_in_model - traces\\$get_CVD)\n\n5.  get CVD, die after first-year ASCVD event\\\n    **cost**: inputs\\$cHealthcareNonCVD \\* traces\\$time_in_model + inputs\\$cNonFatalASCVD + inputs\\$cAnnualFU_afterASCVD \\* (traces\\$time_in_model - traces\\$get_CVD - 1)\\\n    **payoff**: inputs\\$uHealthy \\* traces\\$get_CVD + inputs\\$uAfterASCVD\\*(traces\\$time_in_model - traces\\$get_CVD)\n\n## Statins CEA\n\n\n::: {.cell}\n\n```{.r .cell-code}\nx <- c(31.5, 55, 80)\ny <- c(3901, 8693, 12441)\nparams$model_bgcost <- lm(y ~ x)\n\nx <- c(50, 60, 70, 80, 90)\ny <- c((10.1+4.2)/2/100, (21.4+8.9)/2/100, (34.6+20.0)/2/100, (59.2+40.2)/2/100, (74.4+65.2)/2/100)\nparams$model_cvdpct <- lm(y ~ x)\n\n\ncHealthy = function(inputs, age) {\n  x <- c(31.5, 55, 80)\n  y <- c(3901, 8693, 12441)\n\n  model_bgcost <- lm(y ~ x)\n  intercept_bgcost = coef(model_bgcost)[1]\n  slope_bgcost = coef(model_bgcost)[2]\n\n  x <- c(50, 60, 70, 80, 90)\n  y <- c((10.1+4.2)/2/100, (21.4+8.9)/2/100, (34.6+20.0)/2/100, (59.2+40.2)/2/100, (74.4+65.2)/2/100)\n\n  model_cvdpct <- lm(y ~ x)\n  intercept_cvdpct = coef(model_cvdpct)[1]\n  slope_cvdpct = coef(model_cvdpct)[2]\n  \n  cvdpct = max(intercept_cvdpct + slope_cvdpct*age,0)\n\n  (intercept_bgcost + slope_bgcost*age - cvdpct*(inputs$cAnnualFU_afterASCVD + inputs$cNonFatalASCVD/10)) / (1 - cvdpct)\n}\n\nbasic_CVD_costs = function(inputs, death_after_ASCVD, death_of_ASCVD, death_without_CVD, get_CVD, time_in_model, initial_age) {\n  cost = 0\n  ##cHealthcareNonCVD\n  # if (initial_age < 45) {\n  #   cost = cost + inputs$rInflation2019 * inputs$cHealthcareNonCVD_18_44 * (min(45, time_in_model + initial_age) - initial_age) + inputs$rInflation2019 * inputs$cHealthcareNonCVD_45_64 * (max(time_in_model + initial_age, 45) - 45)\n  # } else if (initial_age >= 45 & initial_age < 55) {\n  #   cost = cost + inputs$rInflation2019 * inputs$cHealthcareNonCVD_45_64 * time_in_model\n  # } else if (initial_age >= 55 & initial_age < 65) {\n  #   cost = cost + inputs$rInflation2019 * inputs$cHealthcareNonCVD_45_64 * (min(65, time_in_model + initial_age) - initial_age) + inputs$rInflation2019 * inputs$cHealthcareNonCVD_65 * (max(time_in_model + initial_age, 65) - 65)\n  # } else {\n  #   cost = cost + inputs$rInflation2019 * inputs$cHealthcareNonCVD_65 * time_in_model\n  # }\n  cost = cost + sum(sapply(initial_age:floor(min(ifelse(is.na(get_CVD),Inf,get_CVD),time_in_model)+initial_age), function(x) cHealthy(inputs, x)))\n  \n  # FatalASCVD\n  if(!is.na(get_CVD) & !is.na(death_of_ASCVD)) {\n    cost = cost + inputs$rInflation2017 * inputs$cFatalASCVD\n  }\n  \n  # Non-Fatal ASCVD\n  if(!is.na(get_CVD) & is.na(death_of_ASCVD)) {\n    cost = cost + inputs$rInflation2017 * inputs$cNonFatalASCVD + inputs$rInflation2017 * inputs$cAnnualFU_afterASCVD * (time_in_model - get_CVD - 1)\n  }\n  return(cost)\n}\n\nadjustment_statins_costs = function(inputs, statins_use, statins_mild_adverse_event, statins_major_adverse_event, get_CVD, time_in_model){\n  if (statins_use == 1){\n    inputs$cAnnualStatin * min(ifelse(is.na(get_CVD),Inf,get_CVD),time_in_model) * inputs$rInflation2017 + \n    ifelse(!is.na(statins_major_adverse_event), inputs$cMajorStatinAdverse, ifelse(!is.na(statins_mild_adverse_event), inputs$cMildStatinAdverse, 0))\n  } else 0\n}\n\n# basic_CVD_utilties = function(inputs, get_CVD, time_in_model){\n#   if (is.na(get_CVD)) {\n#     utility = inputs$uHealthy * time_in_model\n#   } else {\n#     utility = inputs$uHealthy * get_CVD + inputs$uAfterASCVD * (time_in_model - get_CVD)\n#   }\n#   return(utility)\n# }\n\nadjusted_statins_utilities = function(inputs, statins_use, statins_mild_adverse_event, statins_major_adverse_event, get_CVD, time_in_model){\n  if (statins_use == 1) {\n    if (!is.na(statins_major_adverse_event)){\n      uStatins = inputs$uHealthyStatin - inputs$uPenaltyMajorStatinAdverse\n    } else if (!is.na(statins_mild_adverse_event)) {\n      uStatins = inputs$uHealthyStatin - inputs$uPenaltyMildStatinAdverse\n    } else {\n      uStatins = inputs$uHealthyStatin\n    }\n    \n    if (is.na(get_CVD)) {uStatins * time_in_model}\n    else { uStatins * get_CVD + inputs$uAfterASCVD * (time_in_model - get_CVD)}\n  \n    } else {\n    if (is.na(get_CVD)) {return(inputs$uHealthy * time_in_model)\n    } else {return(inputs$uHealthy * get_CVD + inputs$uAfterASCVD * (time_in_model - get_CVD))}\n  }\n}\n```\n:::\n\n\n## Discounting\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbasic_CVD_costs_discounted = function(inputs, death_after_ASCVD, death_of_ASCVD, death_without_CVD, get_CVD, time_in_model, initial_age) {\n  cost = 0\n  ##cHealthcareNonCVD\n  cost = cost + discounted(sum(sapply(initial_age:floor(min(ifelse(is.na(get_CVD),Inf,get_CVD),time_in_model)+initial_age), function(x) cHealthy(inputs, x))), start_year = 0, end_year = min(ifelse(is.na(get_CVD),Inf,get_CVD),time_in_model))\n  \n  # FatalASCVD\n  if(!is.na(get_CVD) & !is.na(death_of_ASCVD)) {\n    cost = cost + discount(inputs$rInflation2017 * inputs$cFatalASCVD, A = death_of_ASCVD)\n  }\n  \n  # Non-Fatal ASCVD\n  if(!is.na(get_CVD) & is.na(death_of_ASCVD)) {\n    cost = cost + discount(inputs$rInflation2017 * inputs$cNonFatalASCVD, A= get_CVD) + discounted(inputs$rInflation2017 * inputs$cAnnualFU_afterASCVD * (time_in_model - get_CVD - 0.5), start_year = get_CVD + 0.5, end_year = time_in_model)\n  }\n  return(cost)\n}\n\nadjustment_statins_costs_discounted = function(inputs, statins_use, statins_mild_adverse_event, statins_major_adverse_event, get_CVD, time_in_model){\n  if (statins_use == 1){\n    discounted(inputs$cAnnualStatin * min(ifelse(is.na(get_CVD),Inf,get_CVD),time_in_model) * inputs$rInflation2017, start_year = 0, end_year = min(ifelse(is.na(get_CVD),Inf,get_CVD),time_in_model)) +\n    ifelse(!is.na(statins_major_adverse_event), discount(inputs$cMajorStatinAdverse, A=0), ifelse(!is.na(statins_mild_adverse_event), discount(inputs$cMildStatinAdverse,A=0), 0))\n  } else 0\n}\n\nadjusted_statins_utilities_discounted = function(inputs, statins_use, statins_mild_adverse_event, statins_major_adverse_event, get_CVD, time_in_model){\n  if (statins_use == 1) {\n    if (!is.na(statins_major_adverse_event)){\n      uStatins = inputs$uHealthyStatin - inputs$uPenaltyMajorStatinAdverse\n    } else if (!is.na(statins_mild_adverse_event)) {\n      uStatins = inputs$uHealthyStatin - inputs$uPenaltyMildStatinAdverse\n    } else {\n      uStatins = inputs$uHealthyStatin\n    }\n    \n    if (is.na(get_CVD)) { discounted(uStatins * time_in_model, start_year = 0, end_year = time_in_model)}\n    else { discounted(uStatins * get_CVD, start_year = 0, end_year = get_CVD) + discounted(inputs$uAfterASCVD * (time_in_model - get_CVD), start_year = get_CVD, end_year = time_in_model)}\n  \n    } else {\n    if (is.na(get_CVD)) {\n      return(discounted(inputs$uHealthy * time_in_model, start_year = 0, end_year = time_in_model))\n    } else {\n      return(discounted(inputs$uHealthy * get_CVD, start_year = 0, end_year = get_CVD) + discounted(inputs$uAfterASCVD * (time_in_model - get_CVD), start_year = get_CVD, end_year = time_in_model))\n      }\n  }\n}\n```\n:::\n",
    "supporting": [
      "CVD_DES_CRN_abstract_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}