<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Astrid Yu, Shawn Garbett, Jinyi Zhu">
<meta name="dcterms.date" content="2023-07-12">

<title>Hanxuan (Astrid) Yu - Common Random Numbers in Discrete Event Simulation for Disease Modeling: A Statin Treatment Case Study</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./bridge_brief.html">Projects</a></li><li class="breadcrumb-item"><a href="./CVD_DES_CRN_abstract.html">CRNs in DES</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Hanxuan (Astrid) Yu</a> 
    </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About Me</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://www.dropbox.com/scl/fi/izravfw594wzi7wv3f7zo/Hanxuan-Yu-s-CV.docx?rlkey=qhl43x2xkfhqi3vvvnfy9egzl&amp;dl=0" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Curriculum Vitae</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Projects</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./bridge_brief.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">BRIDGE Report</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./CVD_DES_CRN_abstract.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">CRNs in DES</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
 <span class="menu-text">Labs</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./MarkovDA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">How to Create Markov Model using R</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./AddingMortality.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Add the Time-Varying Variable into Markov Model</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
 <span class="menu-text">Links to other webs</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://smdm-europe23-what-they-didnt-teach.netlify.app/" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SMDM Europe Short Course (2023)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://vchem-vital-workshop-2022.netlify.app/" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Health Economics Modeling Workshop (2022)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://decision-analysis-2023.netlify.app/" class="sidebar-item-text sidebar-link">
 <span class="menu-text">PUBH 5512 (2023)</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#abstract-body" id="toc-abstract-body" class="nav-link active" data-scroll-target="#abstract-body">Abstract Body</a></li>
  <li><a href="#model-body" id="toc-model-body" class="nav-link" data-scroll-target="#model-body">Model Body</a>
  <ul class="collapse">
  <li><a href="#inputs" id="toc-inputs" class="nav-link" data-scroll-target="#inputs">Inputs</a></li>
  <li><a href="#random-number-generator" id="toc-random-number-generator" class="nav-link" data-scroll-target="#random-number-generator">Random Number Generator</a></li>
  <li><a href="#gompertz-model" id="toc-gompertz-model" class="nav-link" data-scroll-target="#gompertz-model">Gompertz Model</a></li>
  <li><a href="#pce" id="toc-pce" class="nav-link" data-scroll-target="#pce">PCE</a></li>
  <li><a href="#sample-population" id="toc-sample-population" class="nav-link" data-scroll-target="#sample-population">Sample population</a></li>
  </ul></li>
  <li><a href="#intervention" id="toc-intervention" class="nav-link" data-scroll-target="#intervention">Intervention</a></li>
  <li><a href="#des" id="toc-des" class="nav-link" data-scroll-target="#des">DES</a>
  <ul class="collapse">
  <li><a href="#run" id="toc-run" class="nav-link" data-scroll-target="#run">run</a></li>
  </ul></li>
  <li><a href="#cost-effectiveness-analysis" id="toc-cost-effectiveness-analysis" class="nav-link" data-scroll-target="#cost-effectiveness-analysis">Cost-Effectiveness Analysis</a>
  <ul class="collapse">
  <li><a href="#statins-cea" id="toc-statins-cea" class="nav-link" data-scroll-target="#statins-cea">Statins CEA</a></li>
  <li><a href="#discounting" id="toc-discounting" class="nav-link" data-scroll-target="#discounting">Discounting</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Common Random Numbers in Discrete Event Simulation for Disease Modeling: A Statin Treatment Case Study</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Astrid Yu, Shawn Garbett, Jinyi Zhu </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">July 12, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># source("random_draws_for_CVD_PSAs.R")</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># output is the dataset</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>RIPS_CVD_data <span class="ot">=</span> <span class="cf">function</span>(inputs){</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  attributes <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">#outputs &lt;- list()</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (strategy <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>){</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    inputs<span class="sc">$</span>strategy <span class="ot">=</span> strategy</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    run <span class="ot">&lt;-</span> <span class="fu">exec.simulation</span>(inputs)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    run<span class="sc">$</span>strategy <span class="ot">&lt;-</span> strategy</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    at <span class="ot">&lt;-</span> <span class="fu">arrange</span>(<span class="fu">get_mon_attributes</span>(env),name,key,time) <span class="co">#obtain attributes data</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    at<span class="sc">$</span>strategy <span class="ot">&lt;-</span> strategy</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(results)) { results <span class="ot">&lt;-</span> run } <span class="cf">else</span>  {results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, run)}</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(attributes)) { attributes <span class="ot">&lt;-</span> at } <span class="cf">else</span>  {attributes <span class="ot">&lt;-</span> <span class="fu">rbind</span>(attributes, at)}</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(run)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(at)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  repeatSets <span class="ot">=</span> attributes <span class="sc">%&gt;%</span> <span class="fu">filter</span>((key <span class="sc">==</span> <span class="st">"aGetCVD"</span> <span class="sc">|</span> key <span class="sc">==</span> <span class="st">"aStatinsMildAdverse"</span> <span class="sc">|</span> key <span class="sc">==</span> <span class="st">"aStatinsMajorAdverse"</span>) <span class="sc">&amp;</span> <span class="fu">is.infinite</span>(value))</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  casted <span class="ot">=</span> <span class="fu">setdiff</span>(attributes, repeatSets) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>replication, <span class="sc">-</span>time) <span class="sc">%&gt;%</span> <span class="fu">spread</span>(key, value)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>  traces <span class="ot">=</span> results <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>start_time, <span class="sc">-</span>activity_time, <span class="sc">-</span>replication) <span class="sc">%&gt;%</span> <span class="fu">spread</span>(resource, end_time) <span class="sc">%&gt;%</span> </span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(casted <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">statins_use =</span> aUseStatins, <span class="at">initial_age =</span> AgeInitial), <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"name"</span>, <span class="st">"strategy"</span>))</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(traces<span class="sc">$</span>statins_major_adverse_event)) {traces<span class="sc">$</span>statins_major_adverse_event <span class="ot">=</span> <span class="cn">NA</span>}</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># patientWcea = traces %&gt;% </span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   rowwise() %&gt;%</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   mutate(</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     cost_disc = basic_CVD_costs_discounted(inputs, death_after_ASCVD, death_of_ASCVD, death_without_CVD, get_CVD, time_in_model, initial_age) + adjustment_statins_costs_discounted(inputs, statins_use, statins_mild_adverse_event, statins_major_adverse_event, get_CVD, time_in_model),</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     util_disc = adjusted_statins_utilities_discounted(inputs, statins_use, statins_mild_adverse_event, statins_major_adverse_event, get_CVD, time_in_model))</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>  cost_util <span class="ot">=</span> <span class="fu">calc_cost_util</span>(<span class="at">death_of_ASCVD_vec =</span> traces<span class="sc">$</span>death_of_ASCVD,</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>                             <span class="at">get_CVD_vec =</span> traces<span class="sc">$</span>get_CVD, </span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>                             <span class="at">time_in_model_vec =</span> traces<span class="sc">$</span>time_in_model, </span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>                             <span class="at">initial_age_vec =</span> traces<span class="sc">$</span>initial_age,</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>                             <span class="at">statins_use_vec =</span> traces<span class="sc">$</span>statins_use, </span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>                             <span class="at">statins_mild_adverse_event_vec =</span> traces<span class="sc">$</span>statins_mild_adverse_event, </span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>                             <span class="at">statins_major_adverse_event_vec =</span> traces<span class="sc">$</span>statins_major_adverse_event, </span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>                             <span class="at">n_pop =</span> <span class="fu">nrow</span>(traces),</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>                             <span class="at">ar =</span> inputs<span class="sc">$</span>annual_discount_rate,</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>                             <span class="at">bgcost_coef_vec =</span> <span class="fu">coef</span>(inputs<span class="sc">$</span>model_bgcost), </span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>                             <span class="at">cvdpct_coef_vec =</span> <span class="fu">coef</span>(inputs<span class="sc">$</span>model_cvdpct),</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>                             <span class="at">cAnnualFU_afterASCVD =</span> inputs<span class="sc">$</span>cAnnualFU_afterASCVD,</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>                             <span class="at">cNonFatalASCVD =</span> inputs<span class="sc">$</span>cNonFatalASCVD,</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>                             <span class="at">cFatalASCVD =</span> inputs<span class="sc">$</span>cFatalASCVD,</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>                             <span class="at">cAnnualStatin =</span> inputs<span class="sc">$</span>cAnnualStatin,</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>                             <span class="at">cMildStatinAdverse =</span> inputs<span class="sc">$</span>cMildStatinAdverse,</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>                             <span class="at">cMajorStatinAdverse =</span> inputs<span class="sc">$</span>cMajorStatinAdverse,</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>                             <span class="at">rInflation2017 =</span> inputs<span class="sc">$</span>rInflation2017,</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>                             <span class="at">uHealthy =</span> inputs<span class="sc">$</span>uHealthy,</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>                             <span class="at">uAfterASCVD =</span> inputs<span class="sc">$</span>uAfterASCVD,</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>                             <span class="at">uHealthyStatin =</span> inputs<span class="sc">$</span>uHealthyStatin,</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>                             <span class="at">uPenaltyMildStatinAdverse =</span> inputs<span class="sc">$</span>uPenaltyMildStatinAdverse,</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>                             <span class="at">uPenaltyMajorStatinAdverse =</span> inputs<span class="sc">$</span>uPenaltyMajorStatinAdverse)</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>  patientWcea <span class="ot">=</span> <span class="fu">cbind</span>(traces, cost_util)</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(patientWcea)</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a><span class="co"># output is the ICER</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>RIPS_CVD_run <span class="ot">=</span> <span class="cf">function</span>(inputs){</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>  patientWcea <span class="ot">=</span> <span class="fu">RIPS_CVD_data</span>(inputs)</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>  strategyWcea <span class="ot">=</span> patientWcea <span class="sc">%&gt;%</span> </span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(strategy) <span class="sc">%&gt;%</span></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarize</span>(</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>        <span class="at">time_in_model =</span> <span class="fu">mean</span>(time_in_model),</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>        <span class="at">cost =</span> <span class="fu">mean</span>(cost_disc), </span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>        <span class="at">QALY =</span> <span class="fu">mean</span>(util_disc)) <span class="sc">%&gt;%</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">strategy =</span> <span class="fu">ifelse</span>(strategy <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Statins(2013 ACC/AHA)"</span>, <span class="st">"Status Quo"</span>))</span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>  df_cea <span class="ot">=</span> <span class="fu">calculate_icers</span>(<span class="at">cost =</span> strategyWcea<span class="sc">$</span>cost,</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>                         <span class="at">effect =</span> strategyWcea<span class="sc">$</span>QALY,</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>                         <span class="at">strategies =</span> strategyWcea<span class="sc">$</span>strategy) <span class="sc">%&gt;%</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(strategyWcea <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="at">Strategy =</span> strategy, <span class="at">LE =</span> time_in_model))</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df_cea)</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>strategy_compare <span class="ot">=</span> <span class="cf">function</span>(patientWcea){</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>  strategyWcea <span class="ot">=</span> patientWcea <span class="sc">%&gt;%</span> </span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(strategy) <span class="sc">%&gt;%</span></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>      <span class="at">time_in_model =</span> <span class="fu">mean</span>(time_in_model),</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>      <span class="at">cost =</span> <span class="fu">mean</span>(cost_disc), </span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>      <span class="at">QALY =</span> <span class="fu">mean</span>(util_disc)) <span class="sc">%&gt;%</span></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">strategy =</span> <span class="fu">ifelse</span>(strategy <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Treatment"</span>, <span class="st">"Status Quo"</span>))</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>  df_cea <span class="ot">=</span> <span class="fu">calculate_icers</span>(<span class="at">cost =</span> strategyWcea<span class="sc">$</span>cost,</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>                           <span class="at">effect =</span> strategyWcea<span class="sc">$</span>QALY,</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>                           <span class="at">strategies =</span> strategyWcea<span class="sc">$</span>strategy) <span class="sc">%&gt;%</span></span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(strategyWcea <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="at">Strategy =</span> strategy, <span class="at">LE =</span> time_in_model)) <span class="sc">%&gt;%</span></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">NHB =</span> Effect <span class="sc">-</span> Cost<span class="sc">/</span><span class="dv">100000</span>)</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df_cea)</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="abstract-body" class="level1">
<h1>Abstract Body</h1>
<p><strong>Purpose:</strong> Disease simulation techniques, notably microsimulation and discrete event simulation (DES) models, often are challenged with stochastic noise. This noise can mask true differences between strategies and increase both time and resource costs. Despite the extensive application of Common Random Numbers (CRNs), a variance reduction technique, in microsimulation models, their use in DES for disease modeling remains under-explored. To our knowledge, no study has yet explicitly outlined the steps to incorporate CRNs into DES for disease modeling or quantified the resulting efficiency gains. We aim to bridge this research gap and demonstrate the benefits of CRNs in DES for disease modeling.</p>
<p><strong>Methods:</strong> We developed a DES model to evaluate the cost-effectiveness of statin treatment in people aged 40 to 80 in the US at risk of atherosclerotic cardiovascular disease (ASCVD) over a lifetime horizon.The model cohort was populated with the National Health and Nutrition Examination Survey, and parameters were informed from published literature. We compared the incremental net health benefit (iNHB) of statins under two scenarios – with and without the use of CRNs – across a broad range of model cohort sizes. To implement CRNs, we assigned each potential event a patient-specific and event-specific random number that remained consistent across model runs to determine the event occurrence and time to event. Unique to DES, the use of CRNs in our model involved the inverse cumulative distribution function, which transformed CRNs (standard uniform random draws between 0 and 1) into non-uniform quantiles that were used to represent time variables.</p>
<p><strong>Results:</strong> Figure Panel A demonstrates that the use of CRNs led to a monotonic function in the model output, where a lower relative risk consistently resulted in a higher iNHB of statins, effectively reducing noise. Panel B indicates that integrating CRNs within DES resulted in faster stabilization of the model-estimated iNHB around the true value with smaller sample sizes, thereby enhancing efficiency.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"data/rrStatinsASCVD501.RData"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>woCRN <span class="ot">=</span> all_woCRN <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Strategy <span class="sc">==</span> <span class="st">"Statins(2013 ACC/AHA)"</span>) <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(all_woCRN <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Strategy <span class="sc">==</span> <span class="st">"Status Quo"</span>), <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"rrStatinsASCVD"</span>, <span class="st">"time"</span>), <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_statins"</span>, <span class="st">"_quo"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">INHB =</span> NHB_statins <span class="sc">-</span> NHB_quo,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">group =</span> <span class="dv">0</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>wCRN <span class="ot">=</span> all_wCRN <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Strategy <span class="sc">==</span> <span class="st">"Statins(2013 ACC/AHA)"</span>) <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(all_wCRN <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Strategy <span class="sc">==</span> <span class="st">"Status Quo"</span>), <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"rrStatinsASCVD"</span>, <span class="st">"time"</span>), <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_statins"</span>, <span class="st">"_quo"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">INHB =</span> NHB_statins <span class="sc">-</span> NHB_quo,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">group =</span> <span class="dv">1</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>rr501 <span class="ot">=</span> <span class="fu">rbind</span>(woCRN, wCRN) <span class="sc">%&gt;%</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">group =</span> <span class="fu">factor</span>(group, <span class="at">levels =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"without CRNs"</span>, <span class="st">"with CRNs"</span>)))</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>rrStatins501 <span class="ot">=</span> </span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  rr501 <span class="sc">%&gt;%</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> rrStatinsASCVD, <span class="at">y =</span> INHB)) <span class="sc">+</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(. <span class="sc">~</span> group) <span class="sc">+</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Statin treatment efficacy, RR of incident ASCVD"</span>, <span class="at">y =</span> <span class="st">"Incremental Net Health Benefit (in QALYs)"</span>) <span class="sc">+</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>comma)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"data/converge100k.RData"</span>)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>converge_wCRN <span class="ot">=</span> <span class="fu">strategy_compare</span>(patients_wCRN[<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>,])</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>converge_woCRN <span class="ot">=</span> <span class="fu">strategy_compare</span>(patients_woCRN[<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>,])</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (size <span class="cf">in</span> <span class="fu">round</span>(<span class="dv">10</span><span class="sc">^</span>(<span class="fu">seq</span>(<span class="fl">1.25</span>, <span class="dv">5</span>, <span class="at">by =</span> <span class="fl">0.25</span>)))){</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  converge_wCRN <span class="ot">=</span> <span class="fu">rbind</span>(converge_wCRN, <span class="fu">strategy_compare</span>(patients_wCRN[<span class="dv">1</span><span class="sc">:</span>(<span class="dv">2</span><span class="sc">*</span>size),]))</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  converge_woCRN <span class="ot">=</span> <span class="fu">rbind</span>(converge_woCRN, <span class="fu">strategy_compare</span>(patients_woCRN[<span class="dv">1</span><span class="sc">:</span>(<span class="dv">2</span><span class="sc">*</span>size),]))</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>converge_wCRN<span class="sc">$</span>nPop <span class="ot">=</span> <span class="fu">rep</span>(<span class="fu">round</span>(<span class="dv">10</span><span class="sc">^</span><span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="at">by =</span> <span class="fl">0.25</span>)), <span class="at">each =</span> <span class="dv">2</span>)</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>converge_woCRN<span class="sc">$</span>nPop <span class="ot">=</span> <span class="fu">rep</span>(<span class="fu">round</span>(<span class="dv">10</span><span class="sc">^</span><span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="at">by =</span> <span class="fl">0.25</span>)), <span class="at">each =</span> <span class="dv">2</span>)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>converge_wCRN<span class="sc">$</span>nPopLog <span class="ot">=</span> <span class="fu">rep</span>(<span class="fu">seq</span>(<span class="dv">1</span>,<span class="dv">5</span>,<span class="at">by =</span> <span class="fl">0.25</span>), <span class="at">each =</span> <span class="dv">2</span>)</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>converge_woCRN<span class="sc">$</span>nPopLog <span class="ot">=</span> <span class="fu">rep</span>(<span class="fu">seq</span>(<span class="dv">1</span>,<span class="dv">5</span>,<span class="at">by =</span> <span class="fl">0.25</span>), <span class="at">each =</span> <span class="dv">2</span>)</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>converge_wCRN<span class="sc">$</span>group <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>converge_woCRN<span class="sc">$</span>group <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>converge <span class="ot">=</span> <span class="fu">rbind</span>(converge_woCRN, converge_wCRN) <span class="sc">%&gt;%</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">group =</span> <span class="fu">factor</span>(group, <span class="at">levels =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"without CRNs"</span>, <span class="st">"with CRNs"</span>)),</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>         <span class="at">Strategy =</span> <span class="fu">ifelse</span>(Strategy <span class="sc">==</span> <span class="st">"Status Quo"</span>, <span class="st">"No Treatment"</span>, <span class="st">"Statin Treatment"</span>))</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>converge100k <span class="ot">=</span> converge <span class="sc">%&gt;%</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> nPopLog, <span class="at">y =</span> NHB, <span class="at">color =</span> Strategy)) <span class="sc">+</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(. <span class="sc">~</span> group) <span class="sc">+</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> <span class="dv">10</span><span class="sc">^</span><span class="fu">seq</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)) <span class="sc">+</span> </span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#AC3931"</span>, <span class="st">"#6699ff"</span>)) <span class="sc">+</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Sample Size"</span>, <span class="at">y =</span> <span class="st">"Net Health Benefit (in QALYs)"</span>) <span class="sc">+</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr)</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a><span class="co"># ggarrange(rrStatins501, converge100k,</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a><span class="co">#                    legend = "bottom",</span></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a><span class="co">#                    nrow = 2, heights = c(0.45, 0.55),</span></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a><span class="co">#                    labels = "AUTO")</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>rrStatins501</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="CVD_DES_CRN_abstract_files/figure-html/abstract-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>converge100k</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="CVD_DES_CRN_abstract_files/figure-html/abstract-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><strong>Conclusion:</strong> Previous studies have established DES as a more efficient alternative to microsimulation for disease simulation modeling. Our findings reinforce this advantage, suggesting that when DES is further augmented with CRNs, it can achieve even greater efficiency. With less stochastic noise and faster convergence, this increased efficiency can enable more computationally intensive tasks, such as probabilistic sensitivity analysis, model calibration, and value of information analysis.</p>
</section>
<section id="model-body" class="level1">
<h1>Model Body</h1>
<section id="inputs" class="level2">
<h2 class="anchored" data-anchor-id="inputs">Inputs</h2>
<p>Spahillari, et al.&nbsp;(2020)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">eval =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>params <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">## basic/general from Stroke paper, 2023</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">strategy =</span> <span class="dv">0</span>, <span class="co"># or 1</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">vN =</span> <span class="dv">1000</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">vHorizon =</span> <span class="dv">100</span>, <span class="co"># all people should terminate before horizon</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">discount_rate =</span> <span class="fl">0.03</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">wtp =</span> <span class="dv">100000</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">CPI2017 =</span> <span class="fl">245.12</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">CPI2019 =</span> <span class="fl">255.657</span>,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">CPI2020 =</span> <span class="fl">258.811</span>,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="do">## events from paper 2017</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">rrStatinsASCVD =</span> <span class="fl">0.79</span>,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">rrStatinsASCVD_low =</span> <span class="fl">0.77</span>,</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">rrStatinsASCVD_upp =</span> <span class="fl">0.81</span>,</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">rrStatinsASCVD_dist =</span> <span class="st">"lognormal"</span>,</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">hrAfterASCVD =</span> <span class="fl">1.9</span>,</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">hrAfterASCVD_low =</span> <span class="fl">1.60</span>,</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">hrAfterASCVD_upp =</span> <span class="fl">2.40</span>, </span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">hrAfterASCVD_dist =</span> <span class="st">"lognormal"</span>, <span class="co"># log-normal</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">mortalityFirstYearASCVD_female_young =</span> <span class="fl">0.09</span>,</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">mortalityFirstYearASCVD_female_young_dist =</span> <span class="st">"beta"</span>,</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">mortalityFirstYearASCVD_female_old =</span> <span class="fl">0.3</span>,</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">mortalityFirstYearASCVD_female_old_dist =</span> <span class="st">"beta"</span>,</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">mortalityFirstYearASCVD_male_young =</span> <span class="fl">0.14</span>,</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">mortalityFirstYearASCVD_male_young_dist =</span> <span class="st">"beta"</span>,</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">mortalityFirstYearASCVD_male_old =</span> <span class="fl">0.25</span>,</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">mortalityFirstYearASCVD_male_old_dist =</span> <span class="st">"beta"</span>,</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">pMildStatinAdverse =</span> <span class="fl">0.047</span>,</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">pMildStatinAdverse_low =</span> <span class="fl">0.047</span><span class="sc">*</span><span class="fl">0.85</span>, </span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">pMildStatinAdverse_upp =</span> <span class="fl">0.047</span><span class="sc">*</span><span class="fl">1.15</span>,</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">pMildStatinAdverse_dist =</span> <span class="st">"beta"</span>,</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">pMajorStatinAdverse =</span> <span class="fl">0.006</span><span class="sc">/</span><span class="dv">100</span>,</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">pMajorStatinAdverse_low =</span> <span class="fl">0.006</span><span class="sc">/</span><span class="dv">100</span><span class="sc">*</span><span class="fl">0.85</span>,</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">pMajorStatinAdverse_upp =</span> <span class="fl">0.006</span><span class="sc">/</span><span class="dv">100</span><span class="sc">*</span><span class="fl">1.15</span>,</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">pMajorStatinAdverse_dist =</span> <span class="st">"beta"</span>,</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">pMajorStatinAdverseBeingFatal =</span> <span class="fl">0.09</span><span class="sc">/</span><span class="dv">100</span>,</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">pMajorStatinAdverseBeingFatal_low =</span> <span class="fl">0.09</span><span class="sc">/</span><span class="dv">100</span><span class="sc">*</span><span class="fl">0.85</span>,</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">pMajorStatinAdverseBeingFatal_upp =</span> <span class="fl">0.09</span><span class="sc">/</span><span class="dv">100</span><span class="sc">*</span><span class="fl">1.15</span>,</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>  <span class="at">pMajorStatinAdverseBeingFatal_dist =</span> <span class="st">"beta"</span>,</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>  <span class="do">## utility</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>  <span class="at">uHealthy =</span> <span class="dv">1</span>,</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>  <span class="at">uAfterASCVD =</span> <span class="fl">0.773</span>,</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>  <span class="at">uAfterASCVD_low =</span> <span class="fl">0.773</span><span class="sc">*</span><span class="fl">0.85</span>,</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">uAfterASCVD_upp =</span> <span class="fl">0.773</span><span class="sc">*</span><span class="fl">1.15</span>,</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">uAfterASCVD_dist =</span> <span class="st">"beta"</span>,</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>  <span class="at">uHealthyStatin =</span> <span class="fl">0.996</span>,</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>  <span class="at">uHealthyStatin_low =</span> <span class="fl">0.991</span>,</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>  <span class="at">uHealthyStatin_upp =</span> <span class="fl">1.000</span>,</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>  <span class="at">uHealthyStatin_dist =</span> <span class="st">"beta"</span>,</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>  <span class="at">uPenaltyMildStatinAdverse =</span> <span class="sc">-</span><span class="fl">0.0055</span>,</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>  <span class="at">uPenaltyMajorStatinAdverse =</span> <span class="sc">-</span><span class="fl">0.0383</span>,</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>  <span class="at">uDeath =</span> <span class="dv">0</span>,</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>  <span class="do">## cost(2017)</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>  <span class="at">cAnnualFU_afterASCVD =</span> <span class="dv">3917</span>,</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>  <span class="at">cAnnualFU_afterASCVD_low =</span> <span class="dv">2611</span>,</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>  <span class="at">cAnnualFU_afterASCVD_upp =</span> <span class="dv">6528</span>,</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>  <span class="at">cAnnualFU_afterASCVD_dist =</span> <span class="st">"gamma"</span>,</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>  <span class="at">cNonFatalASCVD =</span> <span class="dv">49348</span>,</span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>  <span class="at">cNonFatalASCVD_low =</span> <span class="dv">49348</span><span class="sc">*</span><span class="fl">0.85</span>,</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>  <span class="at">cNonFatalASCVD_upp =</span> <span class="dv">49348</span><span class="sc">*</span><span class="fl">1.15</span>,</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>  <span class="at">cNonFatalASCVD_dist =</span> <span class="st">"gamma"</span>,</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>  <span class="at">cFatalASCVD =</span> <span class="dv">16760</span>,</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>  <span class="at">cFatalASCVD_low =</span> <span class="dv">16760</span><span class="sc">*</span><span class="fl">0.85</span>,</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>  <span class="at">cFatalASCVD_upp =</span> <span class="dv">16760</span><span class="sc">*</span><span class="fl">1.15</span>,</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>  <span class="at">cFatalASCVD_dist =</span> <span class="st">"gamma"</span>,</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>  <span class="at">cAnnualStatin =</span> <span class="dv">84</span>,</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>  <span class="at">cMildStatinAdverse =</span> <span class="dv">215</span>,</span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>  <span class="at">cMildStatinAdverse_low =</span> <span class="dv">196</span>,</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>  <span class="at">cMildStatinAdverse_upp =</span> <span class="dv">326</span>,</span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>  <span class="at">cMildStatinAdverse_dist =</span> <span class="st">"gamma"</span>,</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>  <span class="at">cMajorStatinAdverse =</span> <span class="dv">8486</span>,</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>  <span class="at">cMajorStatinAdverse_low =</span> <span class="dv">6920</span>, </span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>  <span class="at">cMajorStatinAdverse_upp =</span> <span class="dv">10314</span>,</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>  <span class="at">cMajorStatinAdverse_dist =</span> <span class="st">"gamma"</span>,</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>  <span class="at">annual_discount_rate =</span> <span class="fl">0.03</span>,</span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>  <span class="do">### source：Agency for Healthcare Research and Quality. Mean expenditure per person by age groups, United States, 1996 to 2020. Medical Expenditure Panel Survey.(2020)</span></span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>  <span class="at">cHealthcareNonCVD_18_44 =</span> <span class="dv">3901</span>,</span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>  <span class="at">cHealthcareNonCVD_45_64 =</span> <span class="dv">8693</span>,</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>  <span class="at">cHealthcareNonCVD_65 =</span> <span class="dv">12441</span></span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a><span class="do">## inflation</span></span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>params<span class="sc">$</span>rInflation2017 <span class="ot">=</span> params<span class="sc">$</span>CPI2020 <span class="sc">/</span> params<span class="sc">$</span>CPI2017</span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>params<span class="sc">$</span>rInflation2019 <span class="ot">=</span> params<span class="sc">$</span>CPI2020 <span class="sc">/</span> params<span class="sc">$</span>CPI2019</span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a><span class="do">## leave some spaces for PSA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># simply change from prob to rate than to event</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>ProbToRate <span class="ot">=</span> <span class="cf">function</span>(prob, t){</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fu">log</span>(<span class="dv">1</span><span class="sc">-</span>prob)<span class="sc">/</span>t</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>RateToProb <span class="ot">=</span> <span class="cf">function</span>(rate, t){</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span> <span class="sc">-</span> <span class="fu">exp</span>(<span class="sc">-</span>rate<span class="sc">*</span>t)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># # what this t should be -- 10 years?</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># # time unit: year</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># rate = ProbToRate(pcr()/100)</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co"># days = rexp(1,rate)</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>discounted <span class="ot">&lt;-</span> <span class="cf">function</span>(undiscounted, start_year, end_year, <span class="at">rate =</span> params<span class="sc">$</span>annual_discount_rate)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  undiscounted <span class="sc">/</span> <span class="fu">log</span>(<span class="dv">1</span> <span class="sc">+</span> rate) <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span><span class="sc">+</span>rate)<span class="sc">^</span>start_year <span class="sc">-</span> <span class="dv">1</span><span class="sc">/</span> (<span class="dv">1</span><span class="sc">+</span>rate)<span class="sc">^</span>end_year)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>discount <span class="ot">&lt;-</span> <span class="cf">function</span>(value, A, <span class="at">ar=</span>params<span class="sc">$</span>annual_discount_rate) value <span class="sc">/</span> (<span class="dv">1</span><span class="sc">+</span>ar)<span class="sc">^</span>A</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="random-number-generator" class="level2">
<h2 class="anchored" data-anchor-id="random-number-generator">Random Number Generator</h2>
<p>attributes and events for random:</p>
<table class="table">
<colgroup>
<col style="width: 24%">
<col style="width: 24%">
<col style="width: 24%">
<col style="width: 26%">
</colgroup>
<thead>
<tr class="header">
<th>location</th>
<th>attributes/events</th>
<th>without CRN</th>
<th>with CRN</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>initialize_patient</td>
<td><strong>nhanesNo</strong></td>
<td>sample(1:nrow(nhanes_pop), 1, prob=1/nhanes_pop$WTMEC2YR))</td>
<td>nhanes_pop$cum_weight = cumsum(nhanes_pop$WTMEC2YR / sum(nhanes_pop$WTMEC2YR))</td>
</tr>
<tr class="even">
<td>years_till_death_without_CVD</td>
<td><strong>aDeathWithoutCVD</strong></td>
<td>rgompertz(1, shape, rate)</td>
<td>qgompertz(inputs$randomNums[(get_attribute(env,“patientID”))*length(rCRN) + rCRN[“rDeathWithoutCVD”]], shape, rate)</td>
</tr>
<tr class="odd">
<td>years_till_get_CVD</td>
<td><strong>aGetCVD</strong></td>
<td>rexp(1,ProbToRate(prob, 10))</td>
<td>qexp(inputs$randomNums[(get_attribute(env,“patientID”))*length(rCRN) + rCRN[“rGetCVD”]], ProbToRate(prob, 10))</td>
</tr>
<tr class="even">
<td>years_till_death_of_ASCVD</td>
<td><strong>aDeathOfASCVD</strong></td>
<td>sample(0:1, 1, prob = c(1-inputs$mortalityFirstYearASCVD, inputs$mortalityFirstYearASCVD))</td>
<td>ifelse(inputs$randomNums[(get_attribute(env,“patientID”))*length(rCRN) + rCRN[“rDeathOfASCVD”]] &lt; inputs$mortalityFirstYearASCVD, 1, 0)</td>
</tr>
<tr class="odd">
<td>years_till_death_after_ASCVD</td>
<td><strong>aDeathAfterASCVD</strong></td>
<td>rgompertz(1, shape, rate)</td>
<td>qgompertz(inputs$randomNums[(get_attribute(env,“patientID”))*length(rCRN) + rCRN[“rDeathAfterASCVD”]], shape, rate))</td>
</tr>
</tbody>
</table>
<p>Also, need to remind who this individual is inside the DES simulation: get_attribute(env, “patientID”)</p>
<p>CRN will also lead to the same result for the same event. Right now we just loop once, if more will set more CRN.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">114514</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>rCRN <span class="ot">=</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(rCRN) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"nhanesNo"</span>, <span class="st">"rDeathWithoutCVD"</span>, <span class="st">"rGetCVD"</span>, <span class="st">"rDeathOfASCVD"</span>, <span class="st">"rDeathAfterASCVD"</span>, <span class="st">"rStatinsMildAdverse"</span>, <span class="st">"rStatinsMajorAdverse"</span>, <span class="st">"rDeathOfStatinsAdverse"</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>params_CRN <span class="ot">=</span> params</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>params_CRN<span class="sc">$</span>nRN <span class="ot">=</span> params_CRN<span class="sc">$</span>vN <span class="sc">*</span> <span class="fu">length</span>(rCRN)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>params_CRN<span class="sc">$</span>randomNums <span class="ot">=</span> <span class="fu">runif</span>(params_CRN<span class="sc">$</span>nRN)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="gompertz-model" class="level2">
<h2 class="anchored" data-anchor-id="gompertz-model">Gompertz Model</h2>
<p>We use Gompertz model based on US cause-deleted life table to predict the death age.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># source("nonCVD_life_table.R")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># # male</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># mltNonCVD_long = data.frame(Age = rep(NA, ceiling(sum(mlt2020_nonCVD$dx))), Death = rep(1, ceiling(sum(mlt2020_nonCVD$dx))))</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># start = 1</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co"># for (age in 0:(nrow(mlt2020_nonCVD)-1)) {</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   n_row = round(mlt2020_nonCVD[age+1,"dx"])</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   mltNonCVD_long[seq(start,(n_row + start - 1)),"Age"] = age</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   start = start + n_row</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co"># mltNonCVD_long = mltNonCVD_long %&gt;% drop_na()</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co"># parameters_m = data.frame(</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co">#   Age = mlt2020_nonCVD$Age,</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co">#   shape=rep(NA,nrow(mlt2020_nonCVD)),</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="co">#   rate=rep(NA,nrow(mlt2020_nonCVD)))</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="co"># for (age in 0:nrow(mlt2020_nonCVD)-1) {</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="co">#   surv.data &lt;- with(mltNonCVD_long[mltNonCVD_long$Age &gt;= age,], Surv(Age, Death, origin=age))</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="co">#   surv.model &lt;- flexsurvreg(surv.data ~ 1, dist="gompertz")</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="co">#   parameters_m$shape[age+1] &lt;- surv.model$coefficients[1]</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="co">#   parameters_m$rate[age+1] &lt;- exp(surv.model$coefficients[2])</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="co"># # if start since 45-yr</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="co"># # pgompertz(cycle, parameters_m$shape[46], parameters_m$rate[46])</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="co"># # female</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="co"># fltNonCVD_long = data.frame(Age = rep(NA, ceiling(sum(flt2020_nonCVD$dx))), Death = rep(1, ceiling(sum(flt2020_nonCVD$dx))))</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="co"># start = 1</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a><span class="co"># for (age in 0:(nrow(flt2020_nonCVD)-1)) {</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a><span class="co">#   n_row = round(flt2020_nonCVD[age+1,"dx"])</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a><span class="co">#   fltNonCVD_long[seq(start,(n_row + start - 1)),"Age"] = age</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a><span class="co">#   start = start + n_row</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a><span class="co"># fltNonCVD_long = fltNonCVD_long %&gt;% drop_na()</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a><span class="co"># parameters_f = data.frame(</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a><span class="co">#   Age = flt2020_nonCVD$Age,</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a><span class="co">#   shape=rep(NA,nrow(flt2020_nonCVD)),</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a><span class="co">#   rate=rep(NA,nrow(flt2020_nonCVD)))</span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a><span class="co"># for (age in 0:nrow(flt2020_nonCVD)-1) {</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a><span class="co">#   surv.data &lt;- with(fltNonCVD_long[fltNonCVD_long$Age &gt;= age,], Surv(Age, Death, origin=age))</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a><span class="co">#   surv.model &lt;- flexsurvreg(surv.data ~ 1, dist="gompertz")</span></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a><span class="co">#   parameters_f$shape[age+1] &lt;- surv.model$coefficients[1]</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a><span class="co">#   parameters_f$rate[age+1] &lt;- exp(surv.model$coefficients[2])</span></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>ageAtDeath <span class="ot">&lt;-</span> <span class="cf">function</span>(currentAge, gender, inputs, patientID)</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># patientID = get_attribute(env, "patientID")</span></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>  currentAge_f <span class="ot">&lt;-</span> <span class="fu">floor</span>(currentAge) <span class="co">#negative time to secular death issue</span></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Male 1 FEMALE 2</span></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(gender <span class="sc">==</span> <span class="dv">2</span>){</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>    shape <span class="ot">&lt;-</span> parameters_f<span class="sc">$</span>shape[currentAge_f<span class="sc">+</span><span class="dv">1</span>]</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>    rate  <span class="ot">&lt;-</span> parameters_f<span class="sc">$</span>rate[currentAge_f<span class="sc">+</span><span class="dv">1</span>]</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>    shape <span class="ot">&lt;-</span> parameters_m<span class="sc">$</span>shape[currentAge_f<span class="sc">+</span><span class="dv">1</span>]</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>    rate  <span class="ot">&lt;-</span> parameters_m<span class="sc">$</span>rate[currentAge_f<span class="sc">+</span><span class="dv">1</span>]</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">min</span>(currentAge <span class="sc">+</span> <span class="fu">ifelse</span>(<span class="fu">is.null</span>(inputs<span class="sc">$</span>randomNums), <span class="fu">rgompertz</span>(<span class="dv">1</span>, shape, rate), <span class="fu">qgompertz</span>(inputs<span class="sc">$</span>randomNums[(patientID<span class="dv">-1</span>)<span class="sc">*</span><span class="fu">length</span>(rCRN) <span class="sc">+</span> rCRN[<span class="st">"rDeathWithoutCVD"</span>]], shape, rate)), <span class="dv">100</span>)</span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># # male</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># mlt2020_hr = data.frame(Age = 0:(nrow(mlt2020_nonCVD)-1), qx = sapply(sapply(mlt2020_nonCVD$qx, ProbToRate, t = 1) * inputs$hrAfterASCVD, RateToProb, t = 1), lx = rep(0,nrow(mlt2020_nonCVD)), dx = rep(NA,nrow(mlt2020_nonCVD)))</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># mlt2020_hr[1,"lx"] = 100000</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co"># for (i in 1:nrow(mlt2020_hr)) {</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   if (mlt2020_hr[i, "lx"] &gt; 0) {</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     mlt2020_hr[i, "dx"] = round(mlt2020_hr[i, "qx"] * mlt2020_hr[i, "lx"])</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     mlt2020_hr[i+1, "lx"] = mlt2020_hr[i, "lx"] - mlt2020_hr[i, "dx"]</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co"># mlt2020_hr  = mlt2020_hr %&gt;% filter(!is.na(dx))</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co"># mltHr_long = data.frame(Age = rep(NA, 100000), Death = rep(1, 100000))</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="co"># start = 1</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="co"># for (age in 0:(nrow(mlt2020_hr)-1)) {</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="co">#   n_row = mlt2020_hr[age+1,"dx"]</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="co">#   mltHr_long[seq(start,(n_row + start - 1)),"Age"] = age</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="co">#   start = start + n_row</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="co"># parameters_m_hr = data.frame(</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="co">#   Age = mlt2020_hr$Age,</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="co">#   shape=rep(NA,nrow(mlt2020_hr)),</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a><span class="co">#   rate=rep(NA,nrow(mlt2020_hr)))</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a><span class="co"># for (age in 0:nrow(mlt2020_hr)-1) {</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a><span class="co">#   surv.data &lt;- with(mltHr_long[mltHr_long$Age &gt;= age,], Surv(Age, Death, origin=age))</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a><span class="co">#   surv.model &lt;- flexsurvreg(surv.data ~ 1, dist="gompertz")</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a><span class="co">#   parameters_m_hr$shape[age+1] &lt;- surv.model$coefficients[1]</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a><span class="co">#   parameters_m_hr$rate[age+1] &lt;- exp(surv.model$coefficients[2])</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a><span class="co"># # female</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a><span class="co"># flt2020_hr = data.frame(Age = 0:(nrow(flt2020_nonCVD)-1), qx = sapply(sapply(flt2020_nonCVD$qx, ProbToRate, t = 1) * inputs$hrAfterASCVD, RateToProb, t = 1), lx = rep(0,nrow(flt2020_nonCVD)), dx = rep(NA,nrow(flt2020_nonCVD)))</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a><span class="co"># flt2020_hr[1,"lx"] = 100000</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a><span class="co"># for (i in 1:nrow(flt2020_hr)) {</span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a><span class="co">#   if (flt2020_hr[i, "lx"] &gt; 0) {</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a><span class="co">#     flt2020_hr[i, "dx"] = round(flt2020_hr[i, "qx"] * flt2020_hr[i, "lx"])</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a><span class="co">#     flt2020_hr[i+1, "lx"] = flt2020_hr[i, "lx"] - flt2020_hr[i, "dx"]</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a><span class="co"># flt2020_hr  = flt2020_hr %&gt;% filter(!is.na(dx))</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a><span class="co"># fltHr_long = data.frame(Age = rep(NA, 100000), Death = rep(1, 100000))</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a><span class="co"># start = 1</span></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a><span class="co"># for (age in 0:(nrow(flt2020_hr)-1)) {</span></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a><span class="co">#   n_row = flt2020_hr[age+1,"dx"]</span></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a><span class="co">#   fltHr_long[seq(start,(n_row + start - 1)),"Age"] = age</span></span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a><span class="co">#   start = start + n_row</span></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a><span class="co"># parameters_f_hr = data.frame(</span></span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a><span class="co">#   Age = flt2020_hr$Age,</span></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a><span class="co">#   shape=rep(NA,nrow(flt2020_hr)),</span></span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a><span class="co">#   rate=rep(NA,nrow(flt2020_hr)))</span></span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a><span class="co"># for (age in 0:nrow(flt2020_hr)-1) {</span></span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a><span class="co">#   surv.data &lt;- with(fltHr_long[fltHr_long$Age &gt;= age,], Surv(Age, Death, origin=age))</span></span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a><span class="co">#   surv.model &lt;- flexsurvreg(surv.data ~ 1, dist="gompertz")</span></span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a><span class="co">#   parameters_f_hr$shape[age+1] &lt;- surv.model$coefficients[1]</span></span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a><span class="co">#   parameters_f_hr$rate[age+1] &lt;- exp(surv.model$coefficients[2])</span></span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>ageAtDeath_afterASCVD <span class="ot">=</span> <span class="cf">function</span>(currentAge, gender, inputs, patientID)</span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># patientID = get_attribute(env,"patientID")</span></span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>  currentAge_f <span class="ot">&lt;-</span> <span class="fu">floor</span>(currentAge) <span class="co">#negative time to secular death issue</span></span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Male 1 FEMALE 2</span></span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(gender <span class="sc">==</span> <span class="dv">2</span>)</span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>    shape <span class="ot">&lt;-</span> parameters_f_hr<span class="sc">$</span>shape[currentAge_f<span class="sc">+</span><span class="dv">1</span>]</span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>    rate  <span class="ot">&lt;-</span> parameters_f_hr<span class="sc">$</span>rate[currentAge_f<span class="sc">+</span><span class="dv">1</span>]</span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>    age <span class="ot">=</span> <span class="fu">min</span>(currentAge <span class="sc">+</span> <span class="fu">ifelse</span>(<span class="fu">is.null</span>(inputs<span class="sc">$</span>randomNums), <span class="fu">rgompertz</span>(<span class="dv">1</span>, shape, rate), <span class="fu">qgompertz</span>(inputs<span class="sc">$</span>randomNums[(patientID<span class="dv">-1</span>)<span class="sc">*</span><span class="fu">length</span>(rCRN) <span class="sc">+</span> rCRN[<span class="st">"rDeathAfterASCVD"</span>]], shape, rate)), <span class="fu">max</span>(parameters_f_hr<span class="sc">$</span>Age))</span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>    shape <span class="ot">&lt;-</span> parameters_m_hr<span class="sc">$</span>shape[currentAge_f<span class="sc">+</span><span class="dv">1</span>]</span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>    rate  <span class="ot">&lt;-</span> parameters_m_hr<span class="sc">$</span>rate[currentAge_f<span class="sc">+</span><span class="dv">1</span>]</span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>    age <span class="ot">=</span> <span class="fu">min</span>(currentAge <span class="sc">+</span> <span class="fu">ifelse</span>(<span class="fu">is.null</span>(inputs<span class="sc">$</span>randomNums), <span class="fu">rgompertz</span>(<span class="dv">1</span>, shape, rate), <span class="fu">qgompertz</span>(inputs<span class="sc">$</span>randomNums[(patientID<span class="dv">-1</span>)<span class="sc">*</span><span class="fu">length</span>(rCRN) <span class="sc">+</span> rCRN[<span class="st">"rDeathAfterASCVD"</span>]], shape, rate)), <span class="fu">max</span>(parameters_m_hr<span class="sc">$</span>Age))</span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a>  age</span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a><span class="co"># save(parameters_f, parameters_m, parameters_f_hr, parameters_m_hr, file = "life table/MarkovCVD_gompertz.RData")</span></span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a><span class="co"># load("life table/MarkovCVD_gompertz.RData")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="pce" class="level2">
<h2 class="anchored" data-anchor-id="pce">PCE</h2>
<p>We use the pooled cohort equation to calculate the risk of CVD from risk factors.</p>
<p><a href="https://github.com/spgarbet/desdt/tree/main/framingham" class="uri">https://github.com/spgarbet/desdt/tree/main/framingham</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># source('pcr.R')</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># # the probability are percents!!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sample-population" class="level2">
<h2 class="anchored" data-anchor-id="sample-population">Sample population</h2>
<p>We use NHANES study for the simulated population (limited by the PCE limits).</p>
<p>Use the 2017-2018 version: <a href="https://wwwn.cdc.gov/nchs/nhanes/continuousnhanes/default.aspx?BeginYear=2017" class="uri">https://wwwn.cdc.gov/nchs/nhanes/continuousnhanes/default.aspx?BeginYear=2017</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ## SEQN: Respondent sequence number</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># # Examination: Body Measures</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ## BMXBMI - Body Mass Index (kg/m**2)</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ## 12.3 to 86.2   Range of Values</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ## .  Missing</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># nhanes_data_1 = data.frame(read_xpt("./NHANES/BMX_J.XPT", col_select = c("SEQN","BMXBMI")))</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co"># # Lab: Glycohemoglobin</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co"># ## LBXGH: Glycohemoglobin (%)</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co"># nhanes_data_2 = data.frame(read_xpt("./NHANES/GHB_J.XPT", col_select = c("SEQN","LBXGH")))</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co"># # Examination: Blood Pressure</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co"># ## BPXSY1 - Systolic: Blood pres (1st rdg) mm Hg</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co"># ## BPXDI1 - Diastolic: Blood pres (1st rdg) mm Hg</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co"># ## 0 to 136   Range of Values</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co"># ## .  Missing</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co"># nhanes_data_3 = data.frame(read_xpt("./NHANES/BPX_J.XPT", col_select = c("SEQN","BPXDI1","BPXSY1")))</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co"># # Demographic Variables and Sample Weights</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co"># ## RIAGENDR - Gender</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="co"># ## 1  Male</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="co"># ## 2  Female  </span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="co"># ## .  Missing</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="co"># ## RIDAGEYR - Age in years at screening</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="co"># ## 0 to 79    Range of Values</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="co"># ## 80 80 years of age and over</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="co"># ## .  Missing</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="co"># ## RIDRETH1 - Race/Hispanic origin</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a><span class="co"># ## 1  Mexican American    1367    1367    </span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a><span class="co"># ## 2  Other Hispanic  820 2187    </span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="co"># ## 3  Non-Hispanic White  3150    5337    </span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a><span class="co"># ## 4  Non-Hispanic Black  2115    7452    </span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="co"># ## 5  Other Race - Including Multi-Racial 1802    9254    </span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="co"># ## .  Missing</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a><span class="co"># ## WTMEC2YR - Full sample 2 year MEC exam weight</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a><span class="co"># ## 2566.1838545 to 419762.83649   Range of Values</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a><span class="co"># ## 0  Not MEC Examined</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a><span class="co"># ## .  Missing</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a><span class="co"># nhanes_data_4 = data.frame(read_xpt("./NHANES/DEMO_J.XPT", col_select = c("SEQN","RIDAGEYR","RIAGENDR","RIDRETH1","WTMEC2YR"))) #WTMEC2YR is the sample weights variable</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a><span class="co"># # Questionnaire: Diabetes</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a><span class="co"># ## DIQ010 - Doctor told you have diabetes</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a><span class="co"># ## 1  Yes</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a><span class="co"># ## 2  No</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a><span class="co"># ## 3  Borderline</span></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a><span class="co"># ## 7  Refused</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a><span class="co"># ## 9  Don't know</span></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a><span class="co"># ## .  Missing</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a><span class="co"># nhanes_data_5 = data.frame(read_xpt("./NHANES/DIQ_J.XPT", col_select = c("SEQN","DIQ010")))</span></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a><span class="co"># # Lab: Cholesterol - High - Density Lipoprotein</span></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a><span class="co"># ## LBDHDD: Direct HDL-Cholesterol (mg/dL)</span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a><span class="co"># nhanes_data_6 = data.frame(read_xpt("./NHANES/HDL_J.XPT", col_select = c("SEQN","LBDHDD")))</span></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a><span class="co"># # Questionnaire: medical conditions</span></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a><span class="co"># ## MCQ160d: Ever told you had angina/angina pectoris</span></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a><span class="co"># ## MCQ160e: Ever told you had heart attack</span></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a><span class="co"># ## MCQ160f: Ever told you had a stroke</span></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a><span class="co"># ## 1  Yes</span></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a><span class="co"># ## 2  No</span></span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a><span class="co"># ## 7  Refused </span></span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a><span class="co"># ## 9  Don't know</span></span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a><span class="co"># ## .  Missing</span></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a><span class="co"># nhanes_data_7 = data.frame(read_xpt("./NHANES/MCQ_J.XPT", col_select = c("SEQN","MCQ160D","MCQ160F","MCQ160E")))</span></span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a><span class="co"># # Questionnaire: Smoking - Cigarette Use</span></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a><span class="co"># ## SMQ040: Do you now smoke cigarettes?</span></span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a><span class="co"># ## 1  Every day</span></span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a><span class="co"># ## 2  Some days</span></span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a><span class="co"># ## 3  Not at all  </span></span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a><span class="co"># ## 7  Refused</span></span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a><span class="co"># ## 9  Don't know</span></span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a><span class="co"># ## .  Missing</span></span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a><span class="co"># nhanes_data_8 = data.frame(read_xpt("./NHANES/SMQ_J.XPT", col_select = c("SEQN","SMQ040")))</span></span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a><span class="co"># # Lab: Cholesterol - Total</span></span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a><span class="co"># ## LBXTC: Total Cholesterol (mg/dL)</span></span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a><span class="co"># nhanes_data_9 = data.frame(read_xpt("./NHANES/TCHOL_J.XPT", col_select = c("SEQN","LBXTC")))</span></span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a><span class="co"># nhanes_data_10 = data.frame(read_xpt("./NHANES/BPQ_J.XPT", col_select = c("SEQN", "BPQ050A")))</span></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a><span class="co"># # Lab: Cholesterol - Low-Density Lipoproteins (LDL)</span></span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a><span class="co"># ## LBDLDL - LDL-Cholesterol, Friedewald (mg/dL)</span></span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a><span class="co"># nhanes_data_11 = data.frame(read_xpt("./NHANES/TRIGLY_J.XPT", col_select = c("SEQN", "LBDLDL")))</span></span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a><span class="co"># nhanes_data_raw &lt;- list(nhanes_data_1,nhanes_data_2,nhanes_data_3,nhanes_data_4,</span></span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a><span class="co">#                         nhanes_data_5,nhanes_data_6,nhanes_data_7,nhanes_data_8,</span></span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a><span class="co">#                         nhanes_data_9,nhanes_data_10,nhanes_data_11)</span></span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a><span class="co"># nhanes_data_raw &lt;- data.frame(reduce(nhanes_data_raw, full_join, by='SEQN'))</span></span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a><span class="co"># nhanes_pop = nhanes_data_raw %&gt;%</span></span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a><span class="co">#   # whether needs to check missing data</span></span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a><span class="co">#   filter(WTMEC2YR != 0 &amp; RIDAGEYR &gt;= 40 &amp; RIDAGEYR &lt;= 79 &amp; LBXTC &gt;= 30 &amp; LBXTC &lt;= 500 &amp; LBDHDD &gt;= 5 &amp; LBDHDD &lt;= 200 &amp; BPXSY1 &gt;= 60 &amp; BPXSY1 &lt;= 200) %&gt;%</span></span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a><span class="co">#   drop_na() %&gt;%</span></span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(RIDRETH1 = ifelse(RIDRETH1 == 3, 1, ifelse(RIDRETH1 == 4, 2, ifelse(RIDRETH1 %in% c(1,2), 3, 4))))</span></span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a><span class="co"># nhanes_pop$cum_weight = cumsum(nhanes_pop$WTMEC2YR / sum(nhanes_pop$WTMEC2YR))</span></span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>race <span class="ot">=</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span></span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(race) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"White"</span>, <span class="st">"African American"</span>, <span class="st">"Hispanic"</span>, <span class="st">"Other"</span>)</span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>race_convert <span class="ot">=</span> <span class="cf">function</span>(num) {</span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">names</span>(race[num]))</span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>bp_treatment <span class="ot">=</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span></span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(bp_treatment) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Yes"</span>,<span class="st">"No"</span>)</span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a>smoker <span class="ot">=</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span></span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(smoker) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Every day"</span>,<span class="st">"Some days"</span>,<span class="st">"Not at all"</span>)</span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a>diabetic <span class="ot">=</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span></span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(diabetic) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Yes"</span>,<span class="st">"No"</span>)</span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a><span class="co"># save(nhanes_pop, nhanes_data_raw, file = "./NHANES/nhanes_full.RData")</span></span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a><span class="co"># load("./NHANES/nhanes_full.RData")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># for CRN, add an identifier</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>initialize_patient <span class="ot">&lt;-</span> <span class="cf">function</span>(traj, inputs)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        traj <span class="sc">%&gt;%</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>                <span class="fu">seize</span>(<span class="st">"time_in_model"</span>)       <span class="sc">%&gt;%</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                <span class="fu">set_attribute</span>(<span class="st">"patientID"</span>, <span class="cf">function</span>()</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>                  <span class="co"># patientID is 0-index</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">as.numeric</span>(<span class="fu">str_remove</span>(<span class="fu">get_name</span>(env), <span class="st">"patient"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>                <span class="co"># NHANES version</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>                <span class="fu">set_attribute</span>(<span class="st">"nhanesNo"</span>,         <span class="cf">function</span>() <span class="fu">ifelse</span>(</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">is.null</span>(inputs<span class="sc">$</span>randomNums),</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(nhanes_pop), <span class="dv">1</span>, <span class="at">prob=</span>nhanes_pop<span class="sc">$</span>WTMEC2YR),</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">which</span>(nhanes_pop<span class="sc">$</span>cum_weight<span class="sc">&gt;=</span>inputs<span class="sc">$</span>randomNums[(<span class="fu">get_attribute</span>(env,<span class="st">"patientID"</span>))<span class="sc">*</span><span class="fu">length</span>(rCRN) <span class="sc">+</span> rCRN[<span class="st">"nhanesNo"</span>]])[<span class="dv">1</span>])) <span class="sc">%&gt;%</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>                <span class="fu">set_attribute</span>(<span class="st">"Gender"</span>,     <span class="cf">function</span>() nhanes_pop<span class="sc">$</span>RIAGENDR[<span class="fu">get_attribute</span>(env, <span class="st">"nhanesNo"</span>)]) <span class="sc">%&gt;%</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>                <span class="fu">set_attribute</span>(<span class="st">"Age"</span>,        <span class="cf">function</span>() nhanes_pop<span class="sc">$</span>RIDAGEYR[<span class="fu">get_attribute</span>(env, <span class="st">"nhanesNo"</span>)]) <span class="sc">%&gt;%</span> </span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>                <span class="fu">set_attribute</span>(<span class="st">"AgeInitial"</span>, <span class="cf">function</span>() <span class="fu">get_attribute</span>(env, <span class="st">"Age"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>                <span class="fu">set_attribute</span>(<span class="st">"Race"</span>,       <span class="cf">function</span>() nhanes_pop<span class="sc">$</span>RIDRETH1[<span class="fu">get_attribute</span>(env, <span class="st">"nhanesNo"</span>)]) <span class="sc">%&gt;%</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>                <span class="fu">set_attribute</span>(<span class="st">"TotChol"</span>,    <span class="cf">function</span>() nhanes_pop<span class="sc">$</span>LBXTC[<span class="fu">get_attribute</span>(env, <span class="st">"nhanesNo"</span>)]) <span class="sc">%&gt;%</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>                <span class="fu">set_attribute</span>(<span class="st">"HdlChol"</span>,    <span class="cf">function</span>() nhanes_pop<span class="sc">$</span>LBDHDD[<span class="fu">get_attribute</span>(env, <span class="st">"nhanesNo"</span>)]) <span class="sc">%&gt;%</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>                <span class="fu">set_attribute</span>(<span class="st">"LdlChol"</span>,   <span class="cf">function</span>()</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>nhanes_pop<span class="sc">$</span>LBDLDL[<span class="fu">get_attribute</span>(env, <span class="st">"nhanesNo"</span>)]) <span class="sc">%&gt;%</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>                <span class="fu">set_attribute</span>(<span class="st">"SystolicBp"</span>, <span class="cf">function</span>() nhanes_pop<span class="sc">$</span>BPXSY1[<span class="fu">get_attribute</span>(env, <span class="st">"nhanesNo"</span>)]) <span class="sc">%&gt;%</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>                <span class="fu">set_attribute</span>(<span class="st">"BpTreatment"</span>,<span class="cf">function</span>() nhanes_pop<span class="sc">$</span>BPQ050A[<span class="fu">get_attribute</span>(env, <span class="st">"nhanesNo"</span>)]) <span class="sc">%&gt;%</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>                <span class="fu">set_attribute</span>(<span class="st">"Smoker"</span>,      <span class="cf">function</span>() nhanes_pop<span class="sc">$</span>SMQ040[<span class="fu">get_attribute</span>(env, <span class="st">"nhanesNo"</span>)]) <span class="sc">%&gt;%</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>                <span class="fu">set_attribute</span>(<span class="st">"Diabetic"</span>,    <span class="cf">function</span>() nhanes_pop<span class="sc">$</span>DIQ010[<span class="fu">get_attribute</span>(env, <span class="st">"nhanesNo"</span>)]) <span class="sc">%&gt;%</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>                <span class="fu">set_attribute</span>(<span class="st">"PrsZ"</span>,       <span class="cf">function</span>() <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>                <span class="fu">set_attribute</span>(<span class="st">"PCErisk"</span>,    <span class="cf">function</span>()</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pcr</span>(<span class="at">gender =</span> <span class="fu">ifelse</span>(<span class="fu">get_attribute</span>(env, <span class="st">"Gender"</span>) <span class="sc">==</span> <span class="dv">1</span>, <span class="st">'M'</span>, <span class="st">'F'</span>),</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>             <span class="fu">get_attribute</span>(env,<span class="st">"AgeInitial"</span>),</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>             <span class="fu">race_convert</span>(<span class="fu">get_attribute</span>(env, <span class="st">"Race"</span>)),</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>             <span class="fu">get_attribute</span>(env, <span class="st">"TotChol"</span>),</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>             <span class="fu">get_attribute</span>(env, <span class="st">"HdlChol"</span>),</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>             <span class="fu">get_attribute</span>(env, <span class="st">"SystolicBp"</span>),</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>             (<span class="fu">get_attribute</span>(env, <span class="st">"BpTreatment"</span>) <span class="sc">==</span> <span class="dv">1</span>),</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>             (<span class="fu">get_attribute</span>(env, <span class="st">"Smoker"</span>) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>)),</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>             (<span class="fu">get_attribute</span>(env, <span class="st">"Diabetic"</span>) <span class="sc">==</span> <span class="dv">1</span>),</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>             <span class="fu">get_attribute</span>(env, <span class="st">"PrsZ"</span>)</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>             )[<span class="dv">1</span>]<span class="sc">/</span><span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>                <span class="fu">set_attribute</span>(<span class="st">"Strategy"</span>, <span class="cf">function</span>() inputs<span class="sc">$</span>strategy) <span class="sc">%&gt;%</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>                <span class="fu">set_attribute</span>(<span class="st">"aUseStatins"</span>, <span class="cf">function</span>()</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">ifelse</span>(<span class="fu">get_attribute</span>(env, <span class="st">"Strategy"</span>) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>                           (<span class="fu">get_attribute</span>(env, <span class="st">"LdlChol"</span>) <span class="sc">&gt;=</span> <span class="dv">190</span> <span class="sc">|</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">get_attribute</span>(env, <span class="st">"PCErisk"</span>) <span class="sc">&gt;=</span> <span class="fl">0.075</span> <span class="sc">|</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">get_attribute</span>(env, <span class="st">"Diabetic"</span>) <span class="sc">==</span> <span class="dv">1</span>), <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="intervention" class="level1">
<h1>Intervention</h1>
<p>strategy 0. status quo(placebo)</p>
<p>strategy 1. add statins as 2013 ACC/AHA</p>
<p>Individuals(&gt;= 40 yr):</p>
<ul>
<li><p>with diabetes, or</p></li>
<li><p>low-density lipoprotein cholesterol level &gt;= 190 mg/dl, or</p></li>
<li><p>estimated 10-year ASCVD risk greater than or equal to 7.5%.</p></li>
</ul>
<p>Statins will be taken until the ASCVD happen.</p>
<p>Adverse events:</p>
<p>Adverse events will happen immediately after using statins. The major adverse event will overlap the mild adverse event. The death caused by the major adverse event should happen immediately after the event.</p>
</section>
<section id="des" class="level1">
<h1>DES</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>counters <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"get_CVD"</span>, <span class="st">"death_without_CVD"</span>, <span class="st">"death_of_ASCVD"</span>, <span class="st">"death_after_ASCVD"</span>, <span class="st">"statins_mild_adverse_event"</span>, <span class="st">"statins_major_adverse_event"</span>, <span class="st">"death_of_statins_adverse_event"</span>, <span class="st">"time_in_model"</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="do">### Note:</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="do">### As only simulate all the things once, lots of places I use the initial age instead of the updated age. </span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>terminate <span class="ot">&lt;-</span> <span class="cf">function</span>(traj, inputs)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  traj <span class="sc">%&gt;%</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">branch</span>(<span class="cf">function</span>() <span class="dv">1</span>,</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">continue=</span><span class="cn">FALSE</span>,</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>         <span class="fu">trajectory</span>()               <span class="sc">%&gt;%</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>           <span class="fu">release</span>(<span class="st">"time_in_model"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>           <span class="fu">timeout</span>(<span class="dv">0</span>)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="co"># # Statins events</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co"># years_till_use_statins &lt;- function(inputs){</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="co">#   ifelse(get_attribute(env, "Strategy") == 1 &amp;</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="co">#                            (get_attribute(env, "LdlChol") &gt;= 190 |</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="co">#                             get_attribute(env, "PCErisk") &gt;= 0.075 |</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="co">#                             get_attribute(env, "Diabetic") == 1), 0, Inf)</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="co"># event_use_statins &lt;- function(traj, inputs){</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="co">#   traj %&gt;%</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a><span class="co">#     mark("use_statins")</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>years_till_statins_mild_adverse <span class="ot">&lt;-</span> <span class="cf">function</span>(inputs){</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">get_attribute</span>(env, <span class="st">"aUseStatins"</span>) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> <span class="fu">is.na</span>(<span class="fu">get_attribute</span>(env, <span class="st">"aStatinsMildAdverse"</span>))) {</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(<span class="fu">is.null</span>(inputs<span class="sc">$</span>randomNums),</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(<span class="fu">runif</span>(<span class="dv">1</span>)<span class="sc">&lt;</span>inputs<span class="sc">$</span>pMildStatinAdverse,<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(inputs<span class="sc">$</span>randomNums[(<span class="fu">get_attribute</span>(env,<span class="st">"patientID"</span>))<span class="sc">*</span><span class="fu">length</span>(rCRN) <span class="sc">+</span> rCRN[<span class="st">"rStatinsMildAdverse"</span>]]<span class="sc">&lt;</span>inputs<span class="sc">$</span>pMildStatinAdverse, <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cn">Inf</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>event_statins_mild_adverse <span class="ot">&lt;-</span> <span class="cf">function</span>(traj, inputs){</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>  traj <span class="sc">%&gt;%</span> </span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mark</span>(<span class="st">"statins_mild_adverse_event"</span>)</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>years_till_statins_major_adverse <span class="ot">&lt;-</span> <span class="cf">function</span>(inputs){</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">get_attribute</span>(env, <span class="st">"aUseStatins"</span>) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> <span class="fu">is.na</span>(<span class="fu">get_attribute</span>(env, <span class="st">"aStatinsMajorAdverse"</span>))) {</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(<span class="fu">is.null</span>(inputs<span class="sc">$</span>randomNums),</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(<span class="fu">runif</span>(<span class="dv">1</span>)<span class="sc">&lt;</span>inputs<span class="sc">$</span>pMajorStatinAdverse,<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(inputs<span class="sc">$</span>randomNums[(<span class="fu">get_attribute</span>(env,<span class="st">"patientID"</span>))<span class="sc">*</span><span class="fu">length</span>(rCRN) <span class="sc">+</span> rCRN[<span class="st">"rStatinsMajorAdverse"</span>]]<span class="sc">&lt;</span>inputs<span class="sc">$</span>pMajorStatinAdverse, <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cn">Inf</span></span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>event_statins_major_adverse <span class="ot">&lt;-</span> <span class="cf">function</span>(traj, inputs){</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>  traj <span class="sc">%&gt;%</span> </span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mark</span>(<span class="st">"statins_major_adverse_event"</span>)</span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>years_till_death_of_statins_adverse <span class="ot">&lt;-</span> <span class="cf">function</span>(inputs){</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>  time_to_major_adverse <span class="ot">=</span> <span class="fu">get_attribute</span>(env, <span class="st">"aStatinsMajorAdverse"</span>)</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.infinite</span>(time_to_major_adverse)){</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(<span class="fu">is.null</span>(inputs<span class="sc">$</span>randomNums),</span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(<span class="fu">runif</span>(<span class="dv">1</span>)<span class="sc">&lt;</span>inputs<span class="sc">$</span>pMajorStatinAdverseBeingFatal, time_to_major_adverse <span class="sc">+</span><span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(inputs<span class="sc">$</span>randomNums[(<span class="fu">get_attribute</span>(env,<span class="st">"patientID"</span>))<span class="sc">*</span><span class="fu">length</span>(rCRN) <span class="sc">+</span> rCRN[<span class="st">"rDeathOfStatinsAdverse"</span>]] <span class="sc">&lt;</span> inputs<span class="sc">$</span>pMajorStatinAdverseBeingFatal, time_to_major_adverse<span class="sc">+</span><span class="dv">0</span>, <span class="cn">Inf</span>))</span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cn">Inf</span></span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a>event_death_of_statins_adverse <span class="ot">&lt;-</span> <span class="cf">function</span>(traj, inputs){</span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>   traj <span class="sc">%&gt;%</span> </span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_attribute</span>(<span class="st">"AgeDeathStatinsAdverse"</span>, <span class="cf">function</span>() <span class="fu">get_attribute</span>(env,<span class="st">"aDeathOfStatinsAdverse"</span>) <span class="sc">+</span> <span class="fu">get_attribute</span>(env,<span class="st">"AgeInitial"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">branch</span>(</span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>() <span class="dv">1</span>,</span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">continue=</span><span class="fu">c</span>(<span class="cn">TRUE</span>),</span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">trajectory</span>(<span class="st">"Death associated with major adverse events"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mark</span>(<span class="st">"death_of_statins_adverse_event"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a>      <span class="fu">terminate</span>(inputs)</span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a><span class="do">## CVD events</span></span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>years_till_death_without_CVD <span class="ot">&lt;-</span> <span class="cf">function</span>(inputs)</span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a>  age       <span class="ot">&lt;-</span> <span class="fu">get_attribute</span>(env, <span class="st">'Age'</span>)</span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a>  gender    <span class="ot">&lt;-</span> <span class="fu">get_attribute</span>(env, <span class="st">'Gender'</span>)</span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a>  patientID <span class="ot">&lt;-</span> <span class="fu">get_attribute</span>(env, <span class="st">'patientID'</span>)</span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a>  deathAge <span class="ot">=</span> <span class="fu">ageAtDeath</span>(age, gender, inputs, patientID)</span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a>  <span class="do">## the if-else here make sure that if get CVD firstly, will never die of 1.0 BG mortality</span></span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-91"><a href="#cb13-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">ifelse</span>(<span class="fu">get_attribute</span>(env, <span class="st">"aGetCVD"</span>) <span class="sc">&lt;</span> deathAge <span class="sc">-</span> age, <span class="cn">Inf</span>, deathAge <span class="sc">-</span> age))</span>
<span id="cb13-92"><a href="#cb13-92" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-93"><a href="#cb13-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-94"><a href="#cb13-94" aria-hidden="true" tabindex="-1"></a>event_death_without_CVD <span class="ot">&lt;-</span> <span class="cf">function</span>(traj, inputs)</span>
<span id="cb13-95"><a href="#cb13-95" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb13-96"><a href="#cb13-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"event_Death() "</span>, <span class="fu">now</span>(env), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb13-97"><a href="#cb13-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-98"><a href="#cb13-98" aria-hidden="true" tabindex="-1"></a>  traj <span class="sc">%&gt;%</span> </span>
<span id="cb13-99"><a href="#cb13-99" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_attribute</span>(<span class="st">"AgeDeathNonCVD"</span>, <span class="cf">function</span>() <span class="fu">get_attribute</span>(env,<span class="st">"aDeathWithoutCVD"</span>) <span class="sc">+</span> <span class="fu">get_attribute</span>(env,<span class="st">"AgeInitial"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-100"><a href="#cb13-100" aria-hidden="true" tabindex="-1"></a>    <span class="fu">branch</span>(</span>
<span id="cb13-101"><a href="#cb13-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>() <span class="dv">1</span>,</span>
<span id="cb13-102"><a href="#cb13-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">continue=</span><span class="fu">c</span>(<span class="cn">TRUE</span>),</span>
<span id="cb13-103"><a href="#cb13-103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">trajectory</span>(<span class="st">"Death without CVD"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-104"><a href="#cb13-104" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mark</span>(<span class="st">"death_without_CVD"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-105"><a href="#cb13-105" aria-hidden="true" tabindex="-1"></a>      <span class="fu">terminate</span>(inputs)</span>
<span id="cb13-106"><a href="#cb13-106" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-107"><a href="#cb13-107" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-108"><a href="#cb13-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-109"><a href="#cb13-109" aria-hidden="true" tabindex="-1"></a>years_till_get_CVD <span class="ot">&lt;-</span> <span class="cf">function</span>(inputs)</span>
<span id="cb13-110"><a href="#cb13-110" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb13-111"><a href="#cb13-111" aria-hidden="true" tabindex="-1"></a>  gender <span class="ot">=</span> <span class="fu">ifelse</span>(<span class="fu">get_attribute</span>(env, <span class="st">"Gender"</span>) <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"M"</span>, <span class="st">"F"</span>)</span>
<span id="cb13-112"><a href="#cb13-112" aria-hidden="true" tabindex="-1"></a>  race_pcr <span class="ot">=</span> <span class="fu">race_convert</span>(<span class="fu">get_attribute</span>(env, <span class="st">"Race"</span>)) </span>
<span id="cb13-113"><a href="#cb13-113" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-114"><a href="#cb13-114" aria-hidden="true" tabindex="-1"></a>  prob <span class="ot">=</span> <span class="fu">get_attribute</span>(env, <span class="st">"PCErisk"</span>)</span>
<span id="cb13-115"><a href="#cb13-115" aria-hidden="true" tabindex="-1"></a>  useStatins <span class="ot">=</span> <span class="fu">get_attribute</span>(env, <span class="st">"aUseStatins"</span>)</span>
<span id="cb13-116"><a href="#cb13-116" aria-hidden="true" tabindex="-1"></a>  rr <span class="ot">=</span> <span class="fu">ifelse</span>(useStatins <span class="sc">==</span> <span class="dv">1</span>, inputs<span class="sc">$</span>rrStatinsASCVD, <span class="dv">1</span>)</span>
<span id="cb13-117"><a href="#cb13-117" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-118"><a href="#cb13-118" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 10-year probability to 1-year rate</span></span>
<span id="cb13-119"><a href="#cb13-119" aria-hidden="true" tabindex="-1"></a>  years <span class="ot">=</span> <span class="fu">ifelse</span>(<span class="fu">is.null</span>(inputs<span class="sc">$</span>randomNums), <span class="fu">rexp</span>(<span class="dv">1</span>,<span class="fu">ProbToRate</span>(prob, <span class="dv">10</span>)<span class="sc">*</span>rr), <span class="fu">qexp</span>(inputs<span class="sc">$</span>randomNums[(<span class="fu">get_attribute</span>(env,<span class="st">"patientID"</span>))<span class="sc">*</span><span class="fu">length</span>(rCRN) <span class="sc">+</span> rCRN[<span class="st">"rGetCVD"</span>]], <span class="fu">ProbToRate</span>(prob, <span class="dv">10</span>)<span class="sc">*</span>rr))</span>
<span id="cb13-120"><a href="#cb13-120" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-121"><a href="#cb13-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="fu">get_attribute</span>(env, <span class="st">"aGetCVD"</span>)), years, <span class="cn">Inf</span>))</span>
<span id="cb13-122"><a href="#cb13-122" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-123"><a href="#cb13-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-124"><a href="#cb13-124" aria-hidden="true" tabindex="-1"></a>event_get_CVD <span class="ot">=</span> <span class="cf">function</span>(traj, inputs) {</span>
<span id="cb13-125"><a href="#cb13-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"event_get_CVD() "</span>, <span class="fu">now</span>(env), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb13-126"><a href="#cb13-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-127"><a href="#cb13-127" aria-hidden="true" tabindex="-1"></a>  traj <span class="sc">%&gt;%</span></span>
<span id="cb13-128"><a href="#cb13-128" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_attribute</span>(<span class="st">"AgeCVD"</span>, <span class="cf">function</span>() <span class="fu">get_attribute</span>(env,<span class="st">"AgeInitial"</span>) <span class="sc">+</span> <span class="fu">get_attribute</span>(env, <span class="st">"aGetCVD"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-129"><a href="#cb13-129" aria-hidden="true" tabindex="-1"></a>    <span class="fu">branch</span>(</span>
<span id="cb13-130"><a href="#cb13-130" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>() <span class="dv">1</span>,</span>
<span id="cb13-131"><a href="#cb13-131" aria-hidden="true" tabindex="-1"></a>    <span class="at">continue=</span><span class="fu">c</span>(<span class="cn">TRUE</span>),</span>
<span id="cb13-132"><a href="#cb13-132" aria-hidden="true" tabindex="-1"></a>    <span class="fu">trajectory</span>(<span class="st">"Get CVD"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-133"><a href="#cb13-133" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mark</span>(<span class="st">"get_CVD"</span>))</span>
<span id="cb13-134"><a href="#cb13-134" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-135"><a href="#cb13-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-136"><a href="#cb13-136" aria-hidden="true" tabindex="-1"></a>years_till_death_of_ASCVD <span class="ot">=</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb13-137"><a href="#cb13-137" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-138"><a href="#cb13-138" aria-hidden="true" tabindex="-1"></a>  ageCVD    <span class="ot">&lt;-</span> <span class="fu">get_attribute</span>(env, <span class="st">'aGetCVD'</span>) <span class="sc">+</span> <span class="fu">get_attribute</span>(env, <span class="st">"AgeInitial"</span>)</span>
<span id="cb13-139"><a href="#cb13-139" aria-hidden="true" tabindex="-1"></a>  gender    <span class="ot">&lt;-</span> <span class="fu">get_attribute</span>(env, <span class="st">'Gender'</span>)</span>
<span id="cb13-140"><a href="#cb13-140" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-141"><a href="#cb13-141" aria-hidden="true" tabindex="-1"></a>  <span class="do">## getCVD maybe sth really big.</span></span>
<span id="cb13-142"><a href="#cb13-142" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-143"><a href="#cb13-143" aria-hidden="true" tabindex="-1"></a>  age_max <span class="ot">=</span> <span class="fu">ifelse</span>(gender <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">max</span>(parameters_m_hr<span class="sc">$</span>Age), <span class="fu">max</span>(parameters_f_hr<span class="sc">$</span>Age))</span>
<span id="cb13-144"><a href="#cb13-144" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-145"><a href="#cb13-145" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (ageCVD <span class="sc">&gt;=</span> age_max <span class="sc">-</span> <span class="dv">1</span>) {</span>
<span id="cb13-146"><a href="#cb13-146" aria-hidden="true" tabindex="-1"></a>    <span class="co"># not able to use ageAtDeath(ageCVD+1, gender)</span></span>
<span id="cb13-147"><a href="#cb13-147" aria-hidden="true" tabindex="-1"></a>    years <span class="ot">=</span> <span class="fu">get_attribute</span>(env, <span class="st">'aGetCVD'</span>)</span>
<span id="cb13-148"><a href="#cb13-148" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb13-149"><a href="#cb13-149" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ageCVD under the age limitation -- able to use gomepertz</span></span>
<span id="cb13-150"><a href="#cb13-150" aria-hidden="true" tabindex="-1"></a>    <span class="co"># whether ASCVD died in first year happened</span></span>
<span id="cb13-151"><a href="#cb13-151" aria-hidden="true" tabindex="-1"></a>    happen <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb13-152"><a href="#cb13-152" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (gender <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb13-153"><a href="#cb13-153" aria-hidden="true" tabindex="-1"></a>      <span class="do">## men</span></span>
<span id="cb13-154"><a href="#cb13-154" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (ageCVD <span class="sc">&lt;</span> <span class="dv">65</span>) {</span>
<span id="cb13-155"><a href="#cb13-155" aria-hidden="true" tabindex="-1"></a>        happen <span class="ot">=</span> <span class="fu">ifelse</span>(<span class="fu">is.null</span>(inputs<span class="sc">$</span>randomNums),</span>
<span id="cb13-156"><a href="#cb13-156" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">-</span>inputs<span class="sc">$</span>mortalityFirstYearASCVD_male_young, inputs<span class="sc">$</span>mortalityFirstYearASCVD_male_young)),</span>
<span id="cb13-157"><a href="#cb13-157" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">ifelse</span>(inputs<span class="sc">$</span>randomNums[(<span class="fu">get_attribute</span>(env,<span class="st">"patientID"</span>))<span class="sc">*</span><span class="fu">length</span>(rCRN) <span class="sc">+</span> rCRN[<span class="st">"rDeathOfASCVD"</span>]] <span class="sc">&lt;</span> inputs<span class="sc">$</span>mortalityFirstYearASCVD_male_young, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb13-158"><a href="#cb13-158" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb13-159"><a href="#cb13-159" aria-hidden="true" tabindex="-1"></a>          happen <span class="ot">=</span> <span class="fu">ifelse</span>(<span class="fu">is.null</span>(inputs<span class="sc">$</span>randomNums),</span>
<span id="cb13-160"><a href="#cb13-160" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">-</span>inputs<span class="sc">$</span>mortalityFirstYearASCVD_male_old, inputs<span class="sc">$</span>mortalityFirstYearASCVD_male_old)),</span>
<span id="cb13-161"><a href="#cb13-161" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">ifelse</span>(inputs<span class="sc">$</span>randomNums[(<span class="fu">get_attribute</span>(env,<span class="st">"patientID"</span>))<span class="sc">*</span><span class="fu">length</span>(rCRN) <span class="sc">+</span> rCRN[<span class="st">"rDeathOfASCVD"</span>]] <span class="sc">&lt;</span> inputs<span class="sc">$</span>mortalityFirstYearASCVD_male_old, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb13-162"><a href="#cb13-162" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb13-163"><a href="#cb13-163" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb13-164"><a href="#cb13-164" aria-hidden="true" tabindex="-1"></a>        <span class="do">## women</span></span>
<span id="cb13-165"><a href="#cb13-165" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (ageCVD <span class="sc">&lt;</span> <span class="dv">65</span>) {</span>
<span id="cb13-166"><a href="#cb13-166" aria-hidden="true" tabindex="-1"></a>          happen <span class="ot">=</span> <span class="fu">ifelse</span>(<span class="fu">is.null</span>(inputs<span class="sc">$</span>randomNums),</span>
<span id="cb13-167"><a href="#cb13-167" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">-</span>inputs<span class="sc">$</span>mortalityFirstYearASCVD_female_young, inputs<span class="sc">$</span>mortalityFirstYearASCVD_female_young)),</span>
<span id="cb13-168"><a href="#cb13-168" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">ifelse</span>(inputs<span class="sc">$</span>randomNums[(<span class="fu">get_attribute</span>(env,<span class="st">"patientID"</span>))<span class="sc">*</span><span class="fu">length</span>(rCRN) <span class="sc">+</span> rCRN[<span class="st">"rDeathOfASCVD"</span>]] <span class="sc">&lt;</span> inputs<span class="sc">$</span>mortalityFirstYearASCVD_female_young, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb13-169"><a href="#cb13-169" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {</span>
<span id="cb13-170"><a href="#cb13-170" aria-hidden="true" tabindex="-1"></a>            happen <span class="ot">=</span> <span class="fu">ifelse</span>(<span class="fu">is.null</span>(inputs<span class="sc">$</span>randomNums),</span>
<span id="cb13-171"><a href="#cb13-171" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">-</span>inputs<span class="sc">$</span>mortalityFirstYearASCVD_female_old, inputs<span class="sc">$</span>mortalityFirstYearASCVD_female_old)),</span>
<span id="cb13-172"><a href="#cb13-172" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">ifelse</span>(inputs<span class="sc">$</span>randomNums[(<span class="fu">get_attribute</span>(env,<span class="st">"patientID"</span>))<span class="sc">*</span><span class="fu">length</span>(rCRN) <span class="sc">+</span> rCRN[<span class="st">"rDeathOfASCVD"</span>]] <span class="sc">&lt;</span> inputs<span class="sc">$</span>mortalityFirstYearASCVD_female_old, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb13-173"><a href="#cb13-173" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb13-174"><a href="#cb13-174" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb13-175"><a href="#cb13-175" aria-hidden="true" tabindex="-1"></a>    years <span class="ot">=</span> <span class="fu">ifelse</span>(happen <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">get_attribute</span>(env, <span class="st">"aGetCVD"</span>) <span class="sc">+</span> <span class="fl">0.5</span>, <span class="cn">Inf</span>)</span>
<span id="cb13-176"><a href="#cb13-176" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-177"><a href="#cb13-177" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-178"><a href="#cb13-178" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(years)</span>
<span id="cb13-179"><a href="#cb13-179" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-180"><a href="#cb13-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-181"><a href="#cb13-181" aria-hidden="true" tabindex="-1"></a>event_death_of_ASCVD <span class="ot">=</span> <span class="cf">function</span>(traj, inputs) {</span>
<span id="cb13-182"><a href="#cb13-182" aria-hidden="true" tabindex="-1"></a>  traj <span class="sc">%&gt;%</span></span>
<span id="cb13-183"><a href="#cb13-183" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_attribute</span>(<span class="st">"AgeDeathCVD"</span>, <span class="cf">function</span>() <span class="fu">get_attribute</span>(env, <span class="st">"AgeInitial"</span>) <span class="sc">+</span> <span class="fu">now</span>(env)) <span class="sc">%&gt;%</span></span>
<span id="cb13-184"><a href="#cb13-184" aria-hidden="true" tabindex="-1"></a>    <span class="fu">branch</span>(</span>
<span id="cb13-185"><a href="#cb13-185" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>() <span class="dv">1</span>,</span>
<span id="cb13-186"><a href="#cb13-186" aria-hidden="true" tabindex="-1"></a>    <span class="at">continue=</span><span class="fu">c</span>(<span class="cn">TRUE</span>),</span>
<span id="cb13-187"><a href="#cb13-187" aria-hidden="true" tabindex="-1"></a>    <span class="fu">trajectory</span>(<span class="st">"Death of first-year ASCVD"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-188"><a href="#cb13-188" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mark</span>(<span class="st">"death_of_ASCVD"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-189"><a href="#cb13-189" aria-hidden="true" tabindex="-1"></a>      <span class="fu">terminate</span>(inputs)</span>
<span id="cb13-190"><a href="#cb13-190" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-191"><a href="#cb13-191" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-192"><a href="#cb13-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-193"><a href="#cb13-193" aria-hidden="true" tabindex="-1"></a>years_till_death_after_ASCVD <span class="ot">&lt;-</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb13-194"><a href="#cb13-194" aria-hidden="true" tabindex="-1"></a>  <span class="co"># whether die of ASCVD(in &lt;= 1 yr)</span></span>
<span id="cb13-195"><a href="#cb13-195" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.infinite</span>(<span class="fu">get_attribute</span>(env, <span class="st">'aDeathOfASCVD'</span>))) {</span>
<span id="cb13-196"><a href="#cb13-196" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-197"><a href="#cb13-197" aria-hidden="true" tabindex="-1"></a>    ageCVD    <span class="ot">&lt;-</span> <span class="fu">get_attribute</span>(env, <span class="st">'aGetCVD'</span>) <span class="sc">+</span> <span class="fu">get_attribute</span>(env, <span class="st">"AgeInitial"</span>)</span>
<span id="cb13-198"><a href="#cb13-198" aria-hidden="true" tabindex="-1"></a>    gender    <span class="ot">&lt;-</span> <span class="fu">get_attribute</span>(env, <span class="st">'Gender'</span>)</span>
<span id="cb13-199"><a href="#cb13-199" aria-hidden="true" tabindex="-1"></a>    patientID <span class="ot">&lt;-</span> <span class="fu">get_attribute</span>(env, <span class="st">'patientID'</span>)</span>
<span id="cb13-200"><a href="#cb13-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-201"><a href="#cb13-201" aria-hidden="true" tabindex="-1"></a>    deathAge <span class="ot">=</span> <span class="fu">ageAtDeath_afterASCVD</span>(ageCVD <span class="sc">+</span> <span class="dv">1</span>, gender, inputs, patientID)</span>
<span id="cb13-202"><a href="#cb13-202" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-203"><a href="#cb13-203" aria-hidden="true" tabindex="-1"></a>    <span class="co"># GetCVD + ageInitial maybe a impossible number</span></span>
<span id="cb13-204"><a href="#cb13-204" aria-hidden="true" tabindex="-1"></a>    years <span class="ot">=</span> deathAge <span class="sc">-</span> <span class="fu">get_attribute</span>(env, <span class="st">"AgeInitial"</span>)</span>
<span id="cb13-205"><a href="#cb13-205" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-206"><a href="#cb13-206" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb13-207"><a href="#cb13-207" aria-hidden="true" tabindex="-1"></a>    years <span class="ot">=</span> <span class="cn">Inf</span></span>
<span id="cb13-208"><a href="#cb13-208" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-209"><a href="#cb13-209" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-210"><a href="#cb13-210" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(years)</span>
<span id="cb13-211"><a href="#cb13-211" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-212"><a href="#cb13-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-213"><a href="#cb13-213" aria-hidden="true" tabindex="-1"></a>event_death_after_ASCVD <span class="ot">=</span> <span class="cf">function</span>(traj, inputs) {</span>
<span id="cb13-214"><a href="#cb13-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"event_death_with_CVD"</span>, <span class="fu">now</span>(env), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb13-215"><a href="#cb13-215" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-216"><a href="#cb13-216" aria-hidden="true" tabindex="-1"></a>  traj <span class="sc">%&gt;%</span> </span>
<span id="cb13-217"><a href="#cb13-217" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_attribute</span>(<span class="st">"AgeDeathCVD"</span>, <span class="cf">function</span>() <span class="fu">get_attribute</span>(env, <span class="st">"AgeInitial"</span>)<span class="sc">+</span><span class="fu">now</span>(env)) <span class="sc">%&gt;%</span></span>
<span id="cb13-218"><a href="#cb13-218" aria-hidden="true" tabindex="-1"></a>    <span class="fu">branch</span>(</span>
<span id="cb13-219"><a href="#cb13-219" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>() <span class="dv">1</span>,</span>
<span id="cb13-220"><a href="#cb13-220" aria-hidden="true" tabindex="-1"></a>    <span class="at">continue=</span><span class="fu">c</span>(<span class="cn">TRUE</span>),</span>
<span id="cb13-221"><a href="#cb13-221" aria-hidden="true" tabindex="-1"></a>    <span class="fu">trajectory</span>(<span class="st">"Death after ASCVD event"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-222"><a href="#cb13-222" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mark</span>(<span class="st">"death_after_ASCVD"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-223"><a href="#cb13-223" aria-hidden="true" tabindex="-1"></a>      <span class="fu">terminate</span>(inputs)</span>
<span id="cb13-224"><a href="#cb13-224" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-225"><a href="#cb13-225" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-226"><a href="#cb13-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-227"><a href="#cb13-227" aria-hidden="true" tabindex="-1"></a>event_registry <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb13-228"><a href="#cb13-228" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list</span>(<span class="at">name          =</span> <span class="st">"Get CVD"</span>,</span>
<span id="cb13-229"><a href="#cb13-229" aria-hidden="true" tabindex="-1"></a>             <span class="at">attr          =</span> <span class="st">"aGetCVD"</span>,</span>
<span id="cb13-230"><a href="#cb13-230" aria-hidden="true" tabindex="-1"></a>             <span class="at">time_to_event =</span> years_till_get_CVD,</span>
<span id="cb13-231"><a href="#cb13-231" aria-hidden="true" tabindex="-1"></a>             <span class="at">func          =</span> event_get_CVD,</span>
<span id="cb13-232"><a href="#cb13-232" aria-hidden="true" tabindex="-1"></a>             <span class="at">reactive      =</span> <span class="cn">FALSE</span>),</span>
<span id="cb13-233"><a href="#cb13-233" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list</span>(<span class="at">name          =</span> <span class="st">"Death without CVD"</span>,</span>
<span id="cb13-234"><a href="#cb13-234" aria-hidden="true" tabindex="-1"></a>             <span class="at">attr          =</span> <span class="st">"aDeathWithoutCVD"</span>,</span>
<span id="cb13-235"><a href="#cb13-235" aria-hidden="true" tabindex="-1"></a>             <span class="at">time_to_event =</span> years_till_death_without_CVD,</span>
<span id="cb13-236"><a href="#cb13-236" aria-hidden="true" tabindex="-1"></a>             <span class="at">func          =</span> event_death_without_CVD,</span>
<span id="cb13-237"><a href="#cb13-237" aria-hidden="true" tabindex="-1"></a>             <span class="at">reactive      =</span> <span class="cn">FALSE</span>),</span>
<span id="cb13-238"><a href="#cb13-238" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list</span>(<span class="at">name          =</span> <span class="st">"Death of ASCVD"</span>,</span>
<span id="cb13-239"><a href="#cb13-239" aria-hidden="true" tabindex="-1"></a>             <span class="at">attr          =</span> <span class="st">"aDeathOfASCVD"</span>,</span>
<span id="cb13-240"><a href="#cb13-240" aria-hidden="true" tabindex="-1"></a>             <span class="at">time_to_event =</span> years_till_death_of_ASCVD,</span>
<span id="cb13-241"><a href="#cb13-241" aria-hidden="true" tabindex="-1"></a>             <span class="at">func          =</span> event_death_of_ASCVD,</span>
<span id="cb13-242"><a href="#cb13-242" aria-hidden="true" tabindex="-1"></a>             <span class="at">reactive      =</span> <span class="cn">FALSE</span>),</span>
<span id="cb13-243"><a href="#cb13-243" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list</span>(<span class="at">name          =</span> <span class="st">"Death after ASCVD"</span>,</span>
<span id="cb13-244"><a href="#cb13-244" aria-hidden="true" tabindex="-1"></a>             <span class="at">attr          =</span> <span class="st">"aDeathAfterASCVD"</span>,</span>
<span id="cb13-245"><a href="#cb13-245" aria-hidden="true" tabindex="-1"></a>             <span class="at">time_to_event =</span> years_till_death_after_ASCVD,</span>
<span id="cb13-246"><a href="#cb13-246" aria-hidden="true" tabindex="-1"></a>             <span class="at">func          =</span> event_death_after_ASCVD,</span>
<span id="cb13-247"><a href="#cb13-247" aria-hidden="true" tabindex="-1"></a>             <span class="at">reactive      =</span> <span class="cn">FALSE</span>),</span>
<span id="cb13-248"><a href="#cb13-248" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list</span>(<span class="at">name          =</span> <span class="st">"Halt at time horizon"</span>,</span>
<span id="cb13-249"><a href="#cb13-249" aria-hidden="true" tabindex="-1"></a>             <span class="at">attr          =</span> <span class="st">"aTerminate"</span>,</span>
<span id="cb13-250"><a href="#cb13-250" aria-hidden="true" tabindex="-1"></a>             <span class="at">time_to_event =</span> <span class="cf">function</span>(inputs) inputs<span class="sc">$</span>vHorizon,</span>
<span id="cb13-251"><a href="#cb13-251" aria-hidden="true" tabindex="-1"></a>             <span class="at">func          =</span> terminate,</span>
<span id="cb13-252"><a href="#cb13-252" aria-hidden="true" tabindex="-1"></a>             <span class="at">reactive      =</span> <span class="cn">FALSE</span>),</span>
<span id="cb13-253"><a href="#cb13-253" aria-hidden="true" tabindex="-1"></a>        <span class="co"># list(name          = "Use Statins",</span></span>
<span id="cb13-254"><a href="#cb13-254" aria-hidden="true" tabindex="-1"></a>        <span class="co">#      attr          = "aUseStatins",</span></span>
<span id="cb13-255"><a href="#cb13-255" aria-hidden="true" tabindex="-1"></a>        <span class="co">#      time_to_event = years_till_use_statins,</span></span>
<span id="cb13-256"><a href="#cb13-256" aria-hidden="true" tabindex="-1"></a>        <span class="co">#      func          = event_use_statins,</span></span>
<span id="cb13-257"><a href="#cb13-257" aria-hidden="true" tabindex="-1"></a>        <span class="co">#      reactive      = FALSE),</span></span>
<span id="cb13-258"><a href="#cb13-258" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list</span>(<span class="at">name          =</span> <span class="st">"Mild Adverse for Statins"</span>,</span>
<span id="cb13-259"><a href="#cb13-259" aria-hidden="true" tabindex="-1"></a>             <span class="at">attr          =</span> <span class="st">"aStatinsMildAdverse"</span>,</span>
<span id="cb13-260"><a href="#cb13-260" aria-hidden="true" tabindex="-1"></a>             <span class="at">time_to_event =</span> years_till_statins_mild_adverse,</span>
<span id="cb13-261"><a href="#cb13-261" aria-hidden="true" tabindex="-1"></a>             <span class="at">func          =</span> event_statins_mild_adverse,</span>
<span id="cb13-262"><a href="#cb13-262" aria-hidden="true" tabindex="-1"></a>             <span class="at">reactive      =</span> <span class="cn">FALSE</span>),</span>
<span id="cb13-263"><a href="#cb13-263" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list</span>(<span class="at">name          =</span> <span class="st">"Major Adverse for Statins"</span>,</span>
<span id="cb13-264"><a href="#cb13-264" aria-hidden="true" tabindex="-1"></a>             <span class="at">attr          =</span> <span class="st">"aStatinsMajorAdverse"</span>,</span>
<span id="cb13-265"><a href="#cb13-265" aria-hidden="true" tabindex="-1"></a>             <span class="at">time_to_event =</span> years_till_statins_major_adverse,</span>
<span id="cb13-266"><a href="#cb13-266" aria-hidden="true" tabindex="-1"></a>             <span class="at">func          =</span> event_statins_major_adverse,</span>
<span id="cb13-267"><a href="#cb13-267" aria-hidden="true" tabindex="-1"></a>             <span class="at">reactive      =</span> <span class="cn">FALSE</span>),</span>
<span id="cb13-268"><a href="#cb13-268" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list</span>(<span class="at">name          =</span> <span class="st">"Death of Major Adverse for Statins"</span>,</span>
<span id="cb13-269"><a href="#cb13-269" aria-hidden="true" tabindex="-1"></a>             <span class="at">attr          =</span> <span class="st">"aDeathOfStatinsAdverse"</span>,</span>
<span id="cb13-270"><a href="#cb13-270" aria-hidden="true" tabindex="-1"></a>             <span class="at">time_to_event =</span> years_till_death_of_statins_adverse,</span>
<span id="cb13-271"><a href="#cb13-271" aria-hidden="true" tabindex="-1"></a>             <span class="at">func          =</span> event_death_of_statins_adverse,</span>
<span id="cb13-272"><a href="#cb13-272" aria-hidden="true" tabindex="-1"></a>             <span class="at">reactive      =</span> <span class="cn">FALSE</span>)</span>
<span id="cb13-273"><a href="#cb13-273" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-274"><a href="#cb13-274" aria-hidden="true" tabindex="-1"></a><span class="do">## aAgeCVD is not immediately(only get after this happen), but aGetCVD happens at 0.</span></span>
<span id="cb13-275"><a href="#cb13-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-276"><a href="#cb13-276" aria-hidden="true" tabindex="-1"></a><span class="do">## in this way there'll be 2 aGetCVD</span></span>
<span id="cb13-277"><a href="#cb13-277" aria-hidden="true" tabindex="-1"></a><span class="do">## because if getCVD is inside the horizon, there'll be repeats. for the first version, they just died/terminated. </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="run" class="level2">
<h2 class="anchored" data-anchor-id="run">run</h2>
<p>Two versions of event_registry –</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># source("DES.R")</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>env <span class="ot">=</span> <span class="fu">simmer</span>(<span class="st">"CVD"</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>exec.simulation <span class="ot">&lt;-</span> <span class="cf">function</span>(inputs)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">#set.seed(11451428)</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        env  <span class="ot">&lt;&lt;-</span> <span class="fu">simmer</span>(<span class="st">"CVD"</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        traj <span class="ot">&lt;-</span> <span class="fu">simulation</span>(env, inputs)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        env <span class="sc">%&gt;%</span> <span class="fu">create_counters</span>(counters)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>        env <span class="sc">%&gt;%</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>                <span class="fu">add_generator</span>(<span class="st">"patient"</span>, traj, <span class="fu">at</span>(<span class="fu">rep</span>(<span class="dv">0</span>, inputs<span class="sc">$</span>vN)), <span class="at">mon=</span><span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>                <span class="fu">run</span>(inputs<span class="sc">$</span>vHorizon<span class="fl">+1e-6</span>) <span class="sc">%&gt;%</span> <span class="co"># Simulate just past horizon</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>                <span class="fu">wrap</span>()</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">get_mon_arrivals</span>(env, <span class="at">per_resource =</span> T)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="cost-effectiveness-analysis" class="level1">
<h1>Cost-Effectiveness Analysis</h1>
<p>All events continues for 0s except time_in_model. Results only include all things that really happen.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># traces = results %&gt;% filter(name %in% repeatNames2 &amp; resource == "get_CVD") %&gt;% group_by(name, resource) %&gt;% summarize(start_time = min(start_time)) %&gt;%</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   rbind(results %&gt;% filter(!(name %in% repeatNames2) | resource != "get_CVD") %&gt;%</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">#           filter(resource != "time_in_model") %&gt;%</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">#           select(name, resource, start_time)) %&gt;%</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   spread(key = resource, value= start_time) %&gt;%</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   full_join(results %&gt;% filter(resource == "time_in_model") %&gt;% mutate(time_in_model = activity_time) %&gt;% select(name, time_in_model), by = "name") %&gt;%</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   left_join(casted %&gt;% select(name, initial_age = aAgeInitial), by = "name")</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co"># traces %&gt;% filter(get_CVD == death_of_ASCVD)</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>traces <span class="ot">=</span> results <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>start_time, <span class="sc">-</span>activity_time, <span class="sc">-</span>replication) <span class="sc">%&gt;%</span> <span class="fu">spread</span>(resource, end_time) <span class="sc">%&gt;%</span> </span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(casted <span class="sc">%&gt;%</span> <span class="fu">select</span>(name, strategy, <span class="at">statins_use =</span> aUseStatins, <span class="at">initial_age =</span> AgeInitial), <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"name"</span>, <span class="st">"strategy"</span>))</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(traces<span class="sc">$</span>statins_major_adverse_event)) {traces<span class="sc">$</span>statins_major_adverse_event <span class="ot">=</span> <span class="cn">NA</span>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>##Status QUO CEA</p>
<ol type="1">
<li><p>never get CVD, never die before horizon.<br>
<strong>cost</strong>: inputs$cHealthcareNonCVD * traces$time_in_model<br>
<strong>payoff</strong>: inputs$uHealthy * traces$time_in_model</p></li>
<li><p>never get CVD, die of background mortality before horizon<br>
<strong>cost</strong>: inputs$cHealthcareNonCVD * traces$time_in_model<br>
<strong>payoff</strong>: inputs$uHealthy * traces$time_in_model</p></li>
<li><p>get CVD, survive till horizon<br>
<strong>cost</strong>: inputs$cHealthcareNonCVD * traces$time_in_model + inputs$cNonFatalASCVD + inputs$cAnnualFU_afterASCVD * (traces$time_in_model - traces$get_CVD - 1)<br>
<strong>payoff</strong>: inputs$uHealthy * traces$get_CVD + inputs$uAfterASCVD*(traces$time_in_model - traces$get_CVD)</p></li>
<li><p>get CVD, die of first-year ASCVD<br>
<strong>cost</strong>: inputs$cHealthcareNonCVD * traces$time_in_model + inputs$cFatalASCVD<br>
<strong>payoff</strong>: inputs$uHealthy * traces$get_CVD + inputs$uAfterASCVD*(traces$time_in_model - traces$get_CVD)</p></li>
<li><p>get CVD, die after first-year ASCVD event<br>
<strong>cost</strong>: inputs$cHealthcareNonCVD * traces$time_in_model + inputs$cNonFatalASCVD + inputs$cAnnualFU_afterASCVD * (traces$time_in_model - traces$get_CVD - 1)<br>
<strong>payoff</strong>: inputs$uHealthy * traces$get_CVD + inputs$uAfterASCVD*(traces$time_in_model - traces$get_CVD)</p></li>
</ol>
<section id="statins-cea" class="level2">
<h2 class="anchored" data-anchor-id="statins-cea">Statins CEA</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">31.5</span>, <span class="dv">55</span>, <span class="dv">80</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3901</span>, <span class="dv">8693</span>, <span class="dv">12441</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>params<span class="sc">$</span>model_bgcost <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">60</span>, <span class="dv">70</span>, <span class="dv">80</span>, <span class="dv">90</span>)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">c</span>((<span class="fl">10.1+4.2</span>)<span class="sc">/</span><span class="dv">2</span><span class="sc">/</span><span class="dv">100</span>, (<span class="fl">21.4+8.9</span>)<span class="sc">/</span><span class="dv">2</span><span class="sc">/</span><span class="dv">100</span>, (<span class="fl">34.6+20.0</span>)<span class="sc">/</span><span class="dv">2</span><span class="sc">/</span><span class="dv">100</span>, (<span class="fl">59.2+40.2</span>)<span class="sc">/</span><span class="dv">2</span><span class="sc">/</span><span class="dv">100</span>, (<span class="fl">74.4+65.2</span>)<span class="sc">/</span><span class="dv">2</span><span class="sc">/</span><span class="dv">100</span>)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>params<span class="sc">$</span>model_cvdpct <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>cHealthy <span class="ot">=</span> <span class="cf">function</span>(inputs, age) {</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">31.5</span>, <span class="dv">55</span>, <span class="dv">80</span>)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3901</span>, <span class="dv">8693</span>, <span class="dv">12441</span>)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  model_bgcost <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  intercept_bgcost <span class="ot">=</span> <span class="fu">coef</span>(model_bgcost)[<span class="dv">1</span>]</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  slope_bgcost <span class="ot">=</span> <span class="fu">coef</span>(model_bgcost)[<span class="dv">2</span>]</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">60</span>, <span class="dv">70</span>, <span class="dv">80</span>, <span class="dv">90</span>)</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">c</span>((<span class="fl">10.1+4.2</span>)<span class="sc">/</span><span class="dv">2</span><span class="sc">/</span><span class="dv">100</span>, (<span class="fl">21.4+8.9</span>)<span class="sc">/</span><span class="dv">2</span><span class="sc">/</span><span class="dv">100</span>, (<span class="fl">34.6+20.0</span>)<span class="sc">/</span><span class="dv">2</span><span class="sc">/</span><span class="dv">100</span>, (<span class="fl">59.2+40.2</span>)<span class="sc">/</span><span class="dv">2</span><span class="sc">/</span><span class="dv">100</span>, (<span class="fl">74.4+65.2</span>)<span class="sc">/</span><span class="dv">2</span><span class="sc">/</span><span class="dv">100</span>)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>  model_cvdpct <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x)</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>  intercept_cvdpct <span class="ot">=</span> <span class="fu">coef</span>(model_cvdpct)[<span class="dv">1</span>]</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>  slope_cvdpct <span class="ot">=</span> <span class="fu">coef</span>(model_cvdpct)[<span class="dv">2</span>]</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>  cvdpct <span class="ot">=</span> <span class="fu">max</span>(intercept_cvdpct <span class="sc">+</span> slope_cvdpct<span class="sc">*</span>age,<span class="dv">0</span>)</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>  (intercept_bgcost <span class="sc">+</span> slope_bgcost<span class="sc">*</span>age <span class="sc">-</span> cvdpct<span class="sc">*</span>(inputs<span class="sc">$</span>cAnnualFU_afterASCVD <span class="sc">+</span> inputs<span class="sc">$</span>cNonFatalASCVD<span class="sc">/</span><span class="dv">10</span>)) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> cvdpct)</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>basic_CVD_costs <span class="ot">=</span> <span class="cf">function</span>(inputs, death_after_ASCVD, death_of_ASCVD, death_without_CVD, get_CVD, time_in_model, initial_age) {</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>  cost <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>  <span class="do">##cHealthcareNonCVD</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if (initial_age &lt; 45) {</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   cost = cost + inputs$rInflation2019 * inputs$cHealthcareNonCVD_18_44 * (min(45, time_in_model + initial_age) - initial_age) + inputs$rInflation2019 * inputs$cHealthcareNonCVD_45_64 * (max(time_in_model + initial_age, 45) - 45)</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># } else if (initial_age &gt;= 45 &amp; initial_age &lt; 55) {</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   cost = cost + inputs$rInflation2019 * inputs$cHealthcareNonCVD_45_64 * time_in_model</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># } else if (initial_age &gt;= 55 &amp; initial_age &lt; 65) {</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   cost = cost + inputs$rInflation2019 * inputs$cHealthcareNonCVD_45_64 * (min(65, time_in_model + initial_age) - initial_age) + inputs$rInflation2019 * inputs$cHealthcareNonCVD_65 * (max(time_in_model + initial_age, 65) - 65)</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># } else {</span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   cost = cost + inputs$rInflation2019 * inputs$cHealthcareNonCVD_65 * time_in_model</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># }</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>  cost <span class="ot">=</span> cost <span class="sc">+</span> <span class="fu">sum</span>(<span class="fu">sapply</span>(initial_age<span class="sc">:</span><span class="fu">floor</span>(<span class="fu">min</span>(<span class="fu">ifelse</span>(<span class="fu">is.na</span>(get_CVD),<span class="cn">Inf</span>,get_CVD),time_in_model)<span class="sc">+</span>initial_age), <span class="cf">function</span>(x) <span class="fu">cHealthy</span>(inputs, x)))</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># FatalASCVD</span></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(get_CVD) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(death_of_ASCVD)) {</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>    cost <span class="ot">=</span> cost <span class="sc">+</span> inputs<span class="sc">$</span>rInflation2017 <span class="sc">*</span> inputs<span class="sc">$</span>cFatalASCVD</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Non-Fatal ASCVD</span></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(get_CVD) <span class="sc">&amp;</span> <span class="fu">is.na</span>(death_of_ASCVD)) {</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>    cost <span class="ot">=</span> cost <span class="sc">+</span> inputs<span class="sc">$</span>rInflation2017 <span class="sc">*</span> inputs<span class="sc">$</span>cNonFatalASCVD <span class="sc">+</span> inputs<span class="sc">$</span>rInflation2017 <span class="sc">*</span> inputs<span class="sc">$</span>cAnnualFU_afterASCVD <span class="sc">*</span> (time_in_model <span class="sc">-</span> get_CVD <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(cost)</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>adjustment_statins_costs <span class="ot">=</span> <span class="cf">function</span>(inputs, statins_use, statins_mild_adverse_event, statins_major_adverse_event, get_CVD, time_in_model){</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (statins_use <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>    inputs<span class="sc">$</span>cAnnualStatin <span class="sc">*</span> <span class="fu">min</span>(<span class="fu">ifelse</span>(<span class="fu">is.na</span>(get_CVD),<span class="cn">Inf</span>,get_CVD),time_in_model) <span class="sc">*</span> inputs<span class="sc">$</span>rInflation2017 <span class="sc">+</span> </span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(statins_major_adverse_event), inputs<span class="sc">$</span>cMajorStatinAdverse, <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(statins_mild_adverse_event), inputs<span class="sc">$</span>cMildStatinAdverse, <span class="dv">0</span>))</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a><span class="co"># basic_CVD_utilties = function(inputs, get_CVD, time_in_model){</span></span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a><span class="co">#   if (is.na(get_CVD)) {</span></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a><span class="co">#     utility = inputs$uHealthy * time_in_model</span></span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a><span class="co">#   } else {</span></span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a><span class="co">#     utility = inputs$uHealthy * get_CVD + inputs$uAfterASCVD * (time_in_model - get_CVD)</span></span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a><span class="co">#   return(utility)</span></span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>adjusted_statins_utilities <span class="ot">=</span> <span class="cf">function</span>(inputs, statins_use, statins_mild_adverse_event, statins_major_adverse_event, get_CVD, time_in_model){</span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (statins_use <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(statins_major_adverse_event)){</span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>      uStatins <span class="ot">=</span> inputs<span class="sc">$</span>uHealthyStatin <span class="sc">-</span> inputs<span class="sc">$</span>uPenaltyMajorStatinAdverse</span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(statins_mild_adverse_event)) {</span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>      uStatins <span class="ot">=</span> inputs<span class="sc">$</span>uHealthyStatin <span class="sc">-</span> inputs<span class="sc">$</span>uPenaltyMildStatinAdverse</span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a>      uStatins <span class="ot">=</span> inputs<span class="sc">$</span>uHealthyStatin</span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.na</span>(get_CVD)) {uStatins <span class="sc">*</span> time_in_model}</span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> { uStatins <span class="sc">*</span> get_CVD <span class="sc">+</span> inputs<span class="sc">$</span>uAfterASCVD <span class="sc">*</span> (time_in_model <span class="sc">-</span> get_CVD)}</span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-85"><a href="#cb16-85" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb16-86"><a href="#cb16-86" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.na</span>(get_CVD)) {<span class="fu">return</span>(inputs<span class="sc">$</span>uHealthy <span class="sc">*</span> time_in_model)</span>
<span id="cb16-87"><a href="#cb16-87" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {<span class="fu">return</span>(inputs<span class="sc">$</span>uHealthy <span class="sc">*</span> get_CVD <span class="sc">+</span> inputs<span class="sc">$</span>uAfterASCVD <span class="sc">*</span> (time_in_model <span class="sc">-</span> get_CVD))}</span>
<span id="cb16-88"><a href="#cb16-88" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-89"><a href="#cb16-89" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="discounting" class="level2">
<h2 class="anchored" data-anchor-id="discounting">Discounting</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>basic_CVD_costs_discounted <span class="ot">=</span> <span class="cf">function</span>(inputs, death_after_ASCVD, death_of_ASCVD, death_without_CVD, get_CVD, time_in_model, initial_age) {</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  cost <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">##cHealthcareNonCVD</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  cost <span class="ot">=</span> cost <span class="sc">+</span> <span class="fu">discounted</span>(<span class="fu">sum</span>(<span class="fu">sapply</span>(initial_age<span class="sc">:</span><span class="fu">floor</span>(<span class="fu">min</span>(<span class="fu">ifelse</span>(<span class="fu">is.na</span>(get_CVD),<span class="cn">Inf</span>,get_CVD),time_in_model)<span class="sc">+</span>initial_age), <span class="cf">function</span>(x) <span class="fu">cHealthy</span>(inputs, x))), <span class="at">start_year =</span> <span class="dv">0</span>, <span class="at">end_year =</span> <span class="fu">min</span>(<span class="fu">ifelse</span>(<span class="fu">is.na</span>(get_CVD),<span class="cn">Inf</span>,get_CVD),time_in_model))</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># FatalASCVD</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(get_CVD) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(death_of_ASCVD)) {</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    cost <span class="ot">=</span> cost <span class="sc">+</span> <span class="fu">discount</span>(inputs<span class="sc">$</span>rInflation2017 <span class="sc">*</span> inputs<span class="sc">$</span>cFatalASCVD, <span class="at">A =</span> death_of_ASCVD)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Non-Fatal ASCVD</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(get_CVD) <span class="sc">&amp;</span> <span class="fu">is.na</span>(death_of_ASCVD)) {</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    cost <span class="ot">=</span> cost <span class="sc">+</span> <span class="fu">discount</span>(inputs<span class="sc">$</span>rInflation2017 <span class="sc">*</span> inputs<span class="sc">$</span>cNonFatalASCVD, <span class="at">A=</span> get_CVD) <span class="sc">+</span> <span class="fu">discounted</span>(inputs<span class="sc">$</span>rInflation2017 <span class="sc">*</span> inputs<span class="sc">$</span>cAnnualFU_afterASCVD <span class="sc">*</span> (time_in_model <span class="sc">-</span> get_CVD <span class="sc">-</span> <span class="fl">0.5</span>), <span class="at">start_year =</span> get_CVD <span class="sc">+</span> <span class="fl">0.5</span>, <span class="at">end_year =</span> time_in_model)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(cost)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>adjustment_statins_costs_discounted <span class="ot">=</span> <span class="cf">function</span>(inputs, statins_use, statins_mild_adverse_event, statins_major_adverse_event, get_CVD, time_in_model){</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (statins_use <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">discounted</span>(inputs<span class="sc">$</span>cAnnualStatin <span class="sc">*</span> <span class="fu">min</span>(<span class="fu">ifelse</span>(<span class="fu">is.na</span>(get_CVD),<span class="cn">Inf</span>,get_CVD),time_in_model) <span class="sc">*</span> inputs<span class="sc">$</span>rInflation2017, <span class="at">start_year =</span> <span class="dv">0</span>, <span class="at">end_year =</span> <span class="fu">min</span>(<span class="fu">ifelse</span>(<span class="fu">is.na</span>(get_CVD),<span class="cn">Inf</span>,get_CVD),time_in_model)) <span class="sc">+</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(statins_major_adverse_event), <span class="fu">discount</span>(inputs<span class="sc">$</span>cMajorStatinAdverse, <span class="at">A=</span><span class="dv">0</span>), <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(statins_mild_adverse_event), <span class="fu">discount</span>(inputs<span class="sc">$</span>cMildStatinAdverse,<span class="at">A=</span><span class="dv">0</span>), <span class="dv">0</span>))</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>adjusted_statins_utilities_discounted <span class="ot">=</span> <span class="cf">function</span>(inputs, statins_use, statins_mild_adverse_event, statins_major_adverse_event, get_CVD, time_in_model){</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (statins_use <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(statins_major_adverse_event)){</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>      uStatins <span class="ot">=</span> inputs<span class="sc">$</span>uHealthyStatin <span class="sc">-</span> inputs<span class="sc">$</span>uPenaltyMajorStatinAdverse</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(statins_mild_adverse_event)) {</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>      uStatins <span class="ot">=</span> inputs<span class="sc">$</span>uHealthyStatin <span class="sc">-</span> inputs<span class="sc">$</span>uPenaltyMildStatinAdverse</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>      uStatins <span class="ot">=</span> inputs<span class="sc">$</span>uHealthyStatin</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.na</span>(get_CVD)) { <span class="fu">discounted</span>(uStatins <span class="sc">*</span> time_in_model, <span class="at">start_year =</span> <span class="dv">0</span>, <span class="at">end_year =</span> time_in_model)}</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> { <span class="fu">discounted</span>(uStatins <span class="sc">*</span> get_CVD, <span class="at">start_year =</span> <span class="dv">0</span>, <span class="at">end_year =</span> get_CVD) <span class="sc">+</span> <span class="fu">discounted</span>(inputs<span class="sc">$</span>uAfterASCVD <span class="sc">*</span> (time_in_model <span class="sc">-</span> get_CVD), <span class="at">start_year =</span> get_CVD, <span class="at">end_year =</span> time_in_model)}</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.na</span>(get_CVD)) {</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">discounted</span>(inputs<span class="sc">$</span>uHealthy <span class="sc">*</span> time_in_model, <span class="at">start_year =</span> <span class="dv">0</span>, <span class="at">end_year =</span> time_in_model))</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">discounted</span>(inputs<span class="sc">$</span>uHealthy <span class="sc">*</span> get_CVD, <span class="at">start_year =</span> <span class="dv">0</span>, <span class="at">end_year =</span> get_CVD) <span class="sc">+</span> <span class="fu">discounted</span>(inputs<span class="sc">$</span>uAfterASCVD <span class="sc">*</span> (time_in_model <span class="sc">-</span> get_CVD), <span class="at">start_year =</span> get_CVD, <span class="at">end_year =</span> time_in_model))</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>